{% extends 'base.html' %}
{% load static %}

{% block title %}Herramientas Personales{% endblock %}

{% block extra_css %}
<style>
    .tool-card {
        transition: transform 0.2s;
    }
    .tool-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .status-badge {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }
    .filter-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1.5rem;
    }
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">Herramientas Personales</h1>
            <p class="text-muted">Gestión de herramientas y EPP asignados a técnicos</p>
        </div>
        <div>
            <a href="{% url 'gestionDeTaller:personal_tools_dashboard' %}" class="btn btn-info">
                <i class="fas fa-chart-bar"></i> Dashboard
            </a>
            <a href="{% url 'gestionDeTaller:personal_tools_reports' %}" class="btn btn-secondary">
                <i class="fas fa-file-alt"></i> Reportes
            </a>
        </div>
    </div>

    <!-- Estadísticas rápidas -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="stats-card">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">{{ total_herramientas }}</h4>
                        <small>Total Herramientas</small>
                    </div>
                    <i class="fas fa-tools fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="stats-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">{{ herramientas_asignadas }}</h4>
                        <small>Asignadas</small>
                    </div>
                    <i class="fas fa-user-check fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="stats-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">{{ herramientas_disponibles }}</h4>
                        <small>Disponibles</small>
                    </div>
                    <i class="fas fa-check-circle fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="stats-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">{{ herramientas_mantenimiento }}</h4>
                        <small>En Mantenimiento</small>
                    </div>
                    <i class="fas fa-wrench fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="stats-card" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">{{ herramientas_certificacion_vencida }}</h4>
                        <small>Certificación Vencida</small>
                    </div>
                    <i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="stats-card" style="background: linear-gradient(135deg, #ffa726 0%, #ff9800 100%);">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">{{ herramientas_certificacion_proxima_vencer }}</h4>
                        <small>Certificación Próxima</small>
                    </div>
                    <i class="fas fa-clock fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="filter-section">
        <form method="GET" class="row g-3">
            <div class="col-md-3">
                <label for="categoria" class="form-label">Categoría</label>
                <select name="categoria" id="categoria" class="form-select">
                    <option value="">Todas las categorías</option>
                    {% for categoria in categorias %}
                        <option value="{{ categoria.0 }}" {% if request.GET.categoria == categoria.0 %}selected{% endif %}>
                            {{ categoria.1 }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="estado" class="form-label">Estado</label>
                <select name="estado" id="estado" class="form-select">
                    <option value="">Todos los estados</option>
                    {% for estado in estados %}
                        <option value="{{ estado.0 }}" {% if request.GET.estado == estado.0 %}selected{% endif %}>
                            {{ estado.1 }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="tecnico" class="form-label">Técnico</label>
                <select name="tecnico" id="tecnico" class="form-select">
                    <option value="">Todos los técnicos</option>
                    {% for tecnico in tecnicos %}
                        <option value="{{ tecnico.id }}" {% if request.GET.tecnico == tecnico.id|stringformat:"s" %}selected{% endif %}>
                            {{ tecnico.get_full_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button type="submit" class="btn btn-primary me-2">
                    <i class="fas fa-search"></i> Filtrar
                </button>
                <a href="{% url 'gestionDeTaller:personal_tools_list' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-times"></i> Limpiar
                </a>
            </div>
        </form>
    </div>

    <!-- Lista de herramientas -->
    <div class="row">
        {% for tool in tools %}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card tool-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <h5 class="card-title mb-0">{{ tool.codigo }}</h5>
                        <span class="badge status-badge 
                            {% if tool.estado == 'ASIGNADA' %}bg-success
                            {% elif tool.estado == 'DISPONIBLE' %}bg-primary
                            {% elif tool.estado == 'MANTENIMIENTO' %}bg-warning
                            {% else %}bg-secondary{% endif %}">
                            {{ tool.get_estado_display }}
                        </span>
                    </div>
                    
                    <p class="card-text text-muted mb-2">
                        <i class="fas fa-tag"></i> {{ tool.get_categoria_display }}
                    </p>
                    
                    {% if tool.marca %}
                    <p class="card-text text-muted mb-2">
                        <i class="fas fa-industry"></i> {{ tool.marca }}
                    </p>
                    {% endif %}
                    
                    {% if tool.modelo %}
                    <p class="card-text text-muted mb-2">
                        <i class="fas fa-cube"></i> {{ tool.modelo }}
                    </p>
                    {% endif %}
                    
                    {% if tool.requiere_certificacion and tool.fecha_vencimiento_certificacion %}
                    <div class="certification-info mb-2">
                        {% if tool.certificacion_vencida %}
                        <p class="card-text text-danger mb-1">
                            <i class="fas fa-exclamation-triangle"></i> 
                            <strong>Certificación Vencida</strong>
                        </p>
                        {% elif tool.certificacion_proxima_vencer %}
                        <p class="card-text text-warning mb-1">
                            <i class="fas fa-clock"></i> 
                            <strong>Certificación próxima a vencer</strong>
                        </p>
                        {% else %}
                        <p class="card-text text-success mb-1">
                            <i class="fas fa-check-circle"></i> 
                            <strong>Certificación Vigente</strong>
                        </p>
                        {% endif %}
                        <p class="card-text text-muted small mb-0">
                            <i class="fas fa-calendar-alt"></i> 
                            Vence: {{ tool.fecha_vencimiento_certificacion }}
                            {% if tool.dias_vencimiento_certificacion is not None %}
                                ({{ tool.dias_vencimiento_certificacion }} días)
                            {% endif %}
                        </p>
                    </div>
                    {% endif %}
                    
                    {% if tool.asignacion_actual %}
                    <p class="card-text text-muted mb-2">
                        <i class="fas fa-user"></i> {{ tool.asignacion_actual.tecnico.get_full_name }}
                    </p>
                    <p class="card-text text-muted mb-3">
                        <i class="fas fa-calendar"></i> Asignada: {{ tool.asignacion_actual.fecha_asignacion }}
                    </p>
                    {% endif %}
                    
                    {% if tool.ultima_auditoria %}
                    <p class="card-text text-muted mb-3">
                        <i class="fas fa-clipboard-check"></i> Última auditoría: {{ tool.ultima_auditoria.fecha_auditoria }}
                    </p>
                    {% endif %}
                </div>
                
                <div class="card-footer bg-transparent">
                    <div class="btn-group w-100" role="group">
                        <a href="{% url 'gestionDeTaller:personal_tool_detail' tool.id %}" 
                           class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-eye"></i> Ver
                        </a>
                        
                        {% if tool.estado == 'DISPONIBLE' %}
                        <a href="{% url 'gestionDeTaller:assign_personal_tool' tool.id %}" 
                           class="btn btn-outline-success btn-sm">
                            <i class="fas fa-user-plus"></i> Asignar
                        </a>
                        {% endif %}
                        
                        {% if tool.estado == 'ASIGNADA' %}
                        <a href="{% url 'gestionDeTaller:return_personal_tool' tool.id %}" 
                           class="btn btn-outline-warning btn-sm">
                            <i class="fas fa-undo"></i> Devolver
                        </a>
                        {% endif %}
                        
                        <a href="{% url 'gestionDeTaller:audit_personal_tool' tool.id %}" 
                           class="btn btn-outline-info btn-sm">
                            <i class="fas fa-clipboard-check"></i> Auditar
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="text-center py-5">
                <i class="fas fa-tools fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">No se encontraron herramientas</h4>
                <p class="text-muted">Intenta ajustar los filtros de búsqueda</p>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Auto-submit form when filters change
    document.addEventListener('DOMContentLoaded', function() {
        const filterSelects = document.querySelectorAll('#categoria, #estado, #tecnico');
        filterSelects.forEach(select => {
            select.addEventListener('change', function() {
                this.closest('form').submit();
            });
        });
    });
</script>
{% endblock %} 