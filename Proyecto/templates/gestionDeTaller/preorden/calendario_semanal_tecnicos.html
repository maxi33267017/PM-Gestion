{% extends 'base.html' %}
{% load static %}
{% load calendar_filters %}

{% block title %}Calendario Semanal por Técnicos{% endblock %}

{% block content %}
<style>
    /* Variables CSS para consistencia */
    :root {
        --primary-gradient: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        --secondary-gradient: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        --success-gradient: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        --warning-gradient: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        --danger-gradient: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        --dark-gradient: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        --light-gradient: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        --card-shadow: 0 10px 30px rgba(0,0,0,0.1);
        --hover-shadow: 0 15px 40px rgba(0,0,0,0.15);
        --border-radius: 20px;
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Header mejorado */
    .calendar-header {
        background: var(--dark-gradient);
        color: white;
        padding: 3rem 2rem;
        border-radius: var(--border-radius);
        margin-bottom: 2.5rem;
        box-shadow: var(--card-shadow);
        position: relative;
        overflow: hidden;
        text-align: center;
    }
    
    .calendar-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="dots" width="20" height="20" patternUnits="userSpaceOnUse"><circle cx="10" cy="10" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23dots)"/></svg>');
        pointer-events: none;
    }
    
    .calendar-header h1 {
        margin: 0;
        font-weight: 800;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        font-size: 3rem;
        position: relative;
        z-index: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
    }
    
    .calendar-header .subtitle {
        font-size: 1.2rem;
        opacity: 0.9;
        margin-top: 1rem;
        position: relative;
        z-index: 1;
    }

    /* Navegación de semanas */
    .week-navigation {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        padding: 1.5rem 2rem;
        margin-bottom: 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid #e9ecef;
    }
    
    .week-info {
        text-align: center;
        flex: 1;
    }
    
    .week-info h3 {
        margin: 0;
        color: #2c3e50;
        font-weight: 700;
        font-size: 1.5rem;
    }
    
    .week-info p {
        margin: 0.5rem 0 0 0;
        color: #6c757d;
        font-weight: 500;
    }
    
    .nav-buttons {
        display: flex;
        gap: 1rem;
    }
    
    .btn-nav {
        background: var(--dark-gradient);
        color: white;
        border: none;
        border-radius: 25px;
        padding: 0.8rem 1.5rem;
        font-weight: 600;
        transition: var(--transition);
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .btn-nav:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(44, 62, 80, 0.3);
        color: white;
        text-decoration: none;
    }

    /* Tabla del calendario */
    .calendar-table-container {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        overflow: hidden;
        border: 1px solid #e9ecef;
    }
    
    .calendar-table {
        width: 100%;
        border-collapse: collapse;
        margin: 0;
    }
    
    .calendar-table th {
        background: var(--dark-gradient);
        color: white;
        padding: 1rem;
        text-align: center;
        font-weight: 700;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border: 1px solid rgba(255,255,255,0.1);
    }
    
    .calendar-table td {
        padding: 0;
        border: 1px solid #e9ecef;
        vertical-align: top;
        min-height: 120px;
    }
    
    .tecnico-cell {
        background: #f8f9fa;
        padding: 1rem;
        font-weight: 600;
        color: #2c3e50;
        text-align: center;
        min-width: 150px;
        border-right: 2px solid #dee2e6;
    }
    
    .day-cell {
        padding: 0.5rem;
        min-height: 100px;
        background: white;
        transition: var(--transition);
    }
    
    .day-cell:hover {
        background: #f8f9fa;
    }
    
    .day-header {
        background: #e9ecef;
        padding: 0.5rem;
        text-align: center;
        font-weight: 600;
        color: #2c3e50;
        border-bottom: 1px solid #dee2e6;
        font-size: 0.9rem;
    }
    
    .day-content {
        padding: 0.3rem;
        min-height: 50px;
    }

    /* Elementos en las celdas */
    .calendario-item {
        color: white;
        padding: 0.2rem 0.3rem;
        margin: 0.1rem 0;
        border-radius: 4px;
        font-size: 0.65rem;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        box-shadow: 0 1px 4px rgba(0,0,0,0.15);
        border: none;
        text-decoration: none;
        display: block;
        min-height: 1.6rem;
        max-height: 1.6rem;
        overflow: hidden;
    }
    
    .calendario-item:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.25);
        color: white;
        text-decoration: none;
    }
    
    /* Estilos para preórdenes */
    .calendario-item.preorden {
        background: var(--success-gradient);
    }
    
    .calendario-item.preorden.campo {
        background: var(--danger-gradient);
    }
    
    .calendario-item.preorden.taller {
        background: var(--success-gradient);
    }
    
    .calendario-item.preorden.remoto {
        background: var(--warning-gradient);
    }
    
    /* Estilos para servicios - tarjeta compacta */
    .servicios-container {
        position: relative;
        margin: 0.25rem 0;
    }
    
    .servicios-indicator {
        color: white;
        padding: 0.4rem 0.6rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        border: none;
        text-decoration: none;
        display: inline-block;
        text-align: center;
        min-width: 80px;
    }
    
    .servicios-indicator.programados {
        background: var(--secondary-gradient);
    }
    
    .servicios-indicator.en-proceso {
        background: var(--warning-gradient);
    }
    
    .servicios-indicator:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        color: white;
        text-decoration: none;
    }
    
    .servicios-tooltip {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 1000;
        font-size: 0.8rem;
        display: none;
        min-width: 250px;
        transition: all 0.2s ease;
    }
    
    .servicios-tooltip.tooltip-up {
        top: auto;
        bottom: 100%;
        margin-bottom: 5px;
        transform: translateY(-5px);
    }
    
    .servicios-container:hover .servicios-tooltip {
        display: block;
    }
    
    .servicio-item-tooltip {
        background: var(--warning-gradient);
        color: white;
        padding: 0.5rem;
        margin: 0.25rem 0;
        border-radius: 6px;
        font-size: 0.75rem;
        text-decoration: none;
        display: block;
        transition: var(--transition);
    }
    
    .servicio-item-tooltip:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        color: white;
        text-decoration: none;
    }
    
    .item-tipo {
        font-weight: 700;
        font-size: 0.6rem;
        margin-bottom: 0.05rem;
        opacity: 0.9;
        line-height: 1;
    }
    
    .item-numero {
        font-weight: 700;
        font-size: 0.7rem;
        line-height: 1;
    }
    
    .item-cliente {
        font-size: 0.55rem;
        opacity: 0.9;
        margin-top: 0.05rem;
        line-height: 1;
    }
    
    .item-equipo {
        font-size: 0.5rem;
        opacity: 0.8;
        margin-top: 0.02rem;
        line-height: 1;
    }
    
    .item-estado {
        font-size: 0.55rem;
        opacity: 0.85;
        margin-top: 0.05rem;
        font-style: italic;
        line-height: 1;
    }

    /* Botón volver */
    .btn-volver {
        background: var(--dark-gradient);
        color: white;
        border: none;
        border-radius: 25px;
        padding: 1rem 2rem;
        font-weight: 600;
        transition: var(--transition);
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 2rem;
    }
    
    .btn-volver:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(44, 62, 80, 0.3);
        color: white;
        text-decoration: none;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .calendar-header h1 {
            font-size: 2rem;
        }
        
        .week-navigation {
            flex-direction: column;
            gap: 1rem;
        }
        
        .nav-buttons {
            width: 100%;
            justify-content: center;
        }
        
        .calendar-table {
            font-size: 0.8rem;
        }
        
        .tecnico-cell {
            min-width: 100px;
            padding: 0.5rem;
        }
        
        .calendario-item {
            font-size: 0.55rem;
            padding: 0.15rem 0.25rem;
            min-height: 1.4rem;
            max-height: 1.4rem;
        }
        
        .servicios-indicator {
            font-size: 0.65rem;
            padding: 0.3rem 0.5rem;
            min-width: 60px;
        }
        
        .legend-items {
            flex-direction: column;
            gap: 1rem;
        }
    }
</style>

<main class="container-fluid mt-4">
    <!-- Header -->
    <div class="calendar-header">
        <h1>
            <i class="bi bi-people-fill"></i>
            Calendario Semanal por Técnicos
        </h1>
        <div class="subtitle">
            Visualice preórdenes programadas, servicios programados y servicios en proceso asignados a cada técnico
        </div>
    </div>

    <!-- Navegación de semanas -->
    <div class="week-navigation">
        <a href="?fecha={{ semana_anterior|date:'Y-m-d' }}" class="btn-nav">
            <i class="bi bi-chevron-left"></i>
            Semana Anterior
        </a>
        
        <div class="week-info">
            <h3>
                <i class="bi bi-calendar-week"></i>
                Semana del {{ lunes|date:"d/m/Y" }} al {{ sabado|date:"d/m/Y" }}
            </h3>
            <p>Navegue entre semanas para ver preórdenes y servicios programados/en proceso</p>
        </div>
        
        <a href="?fecha={{ semana_siguiente|date:'Y-m-d' }}" class="btn-nav">
            Semana Siguiente
            <i class="bi bi-chevron-right"></i>
        </a>
    </div>

    <!-- Leyenda -->
    <div class="legend-container" style="background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); padding: 1.5rem; margin-bottom: 2rem; border: 1px solid #e9ecef;">
        <div class="legend-title" style="font-weight: 700; color: #2c3e50; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            <i class="bi bi-info-circle"></i>
            Leyenda
        </div>
        <div class="legend-items" style="display: flex; gap: 2rem; flex-wrap: wrap;">
            <div class="legend-item" style="display: flex; align-items: center; gap: 0.5rem;">
                <span style="background: var(--success-gradient); color: white; padding: 0.3rem 0.6rem; border-radius: 4px; font-weight: 700; font-size: 0.8rem;">P</span>
                <span style="font-size: 0.9rem;">Preorden Taller</span>
            </div>
            <div class="legend-item" style="display: flex; align-items: center; gap: 0.5rem;">
                <span style="background: var(--danger-gradient); color: white; padding: 0.3rem 0.6rem; border-radius: 4px; font-weight: 700; font-size: 0.8rem;">P</span>
                <span style="font-size: 0.9rem;">Preorden en Campo</span>
            </div>
            <div class="legend-item" style="display: flex; align-items: center; gap: 0.5rem;">
                <span style="background: var(--secondary-gradient); color: white; padding: 0.3rem 0.6rem; border-radius: 4px; font-weight: 700; font-size: 0.8rem;">
                    <i class="bi bi-calendar-check"></i>
                </span>
                <span style="font-size: 0.9rem;">Servicios Programados</span>
            </div>
            <div class="legend-item" style="display: flex; align-items: center; gap: 0.5rem;">
                <span style="background: var(--warning-gradient); color: white; padding: 0.3rem 0.6rem; border-radius: 4px; font-weight: 700; font-size: 0.8rem;">
                    <i class="bi bi-tools"></i>
                </span>
                <span style="font-size: 0.9rem;">Servicios en Proceso</span>
            </div>
        </div>
    </div>

    <!-- Tabla del calendario -->
    <div class="calendar-table-container">
        <table class="calendar-table">
            <thead>
                <tr>
                    <th style="width: 150px;">
                        <i class="bi bi-person"></i>
                        Técnico
                    </th>
                    {% for nombre_dia in nombres_dias %}
                        <th>
                            <i class="bi bi-calendar-day"></i>
                            {{ nombre_dia }}
                        </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for tecnico_id, datos_tecnico in calendario_tecnicos.items %}
                    <tr>
                        <td class="tecnico-cell">
                            <div>
                                <strong>{{ datos_tecnico.tecnico.get_nombre_completo }}</strong>
                            </div>
                        </td>
                        {% for i in "123456" %}
                            {% with fecha=lunes|add_days:forloop.counter0 %}
                                <td class="day-cell">
                                    <div class="day-header">
                                        {{ fecha|date:"d/m" }}
                                    </div>
                                    <div class="day-content">
                                        {% with dia_data=datos_tecnico.dias|get_item:fecha %}
                                            {% comment %} Mostrar preórdenes {% endcomment %}
                                            {% for preorden in dia_data.preordenes %}
                                                <a href="{% url 'gestionDeTaller:detalle_preorden' preorden.numero %}" 
                                                   class="calendario-item preorden {% if preorden.tipo_trabajo == 'PRESENCIAL_CAMPO' %}campo{% elif preorden.tipo_trabajo == 'PRESENCIAL_TALLER' %}taller{% else %}remoto{% endif %}">
                                                    <div class="item-tipo">P</div>
                                                    <div class="item-numero">
                                                        #{{ preorden.numero }}
                                                    </div>
                                                    <div class="item-cliente">
                                                        {{ preorden.cliente.razon_social|truncatechars:20 }}
                                                    </div>
                                                    <div class="item-equipo">
                                                        {{ preorden.equipo.numero_serie|truncatechars:15 }}
                                                    </div>
                                                </a>
                                            {% endfor %}
                                            
                                            {% comment %} Mostrar indicador de servicios programados si hay servicios {% endcomment %}
                                            {% if dia_data.servicios_programados|length > 0 %}
                                                <div class="servicios-container">
                                                    <div class="servicios-indicator programados">
                                                        <i class="bi bi-calendar-check"></i>
                                                        {{ dia_data.servicios_programados|length }} programados
                                                    </div>
                                                    <div class="servicios-tooltip">
                                                        <div style="font-weight: 700; margin-bottom: 0.5rem; color: #2c3e50;">
                                                            <i class="bi bi-calendar-check"></i>
                                                            Servicios Programados
                                                        </div>
                                                        {% for servicio in dia_data.servicios_programados %}
                                                            <a href="{% url 'gestionDeTaller:detalle_servicio' servicio.id %}" 
                                                               class="servicio-item-tooltip">
                                                                <div style="font-weight: 600;">
                                                                    #{{ servicio.id }} - {{ servicio.preorden.cliente.razon_social|truncatechars:25 }}
                                                                </div>
                                                                <div style="font-size: 0.7rem; opacity: 0.9;">
                                                                    {{ servicio.preorden.equipo.numero_serie|truncatechars:20 }}
                                                                </div>
                                                            </a>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                            {% endif %}
                                            
                                            {% comment %} Mostrar indicador de servicios en proceso si hay servicios {% endcomment %}
                                            {% if dia_data.servicios_en_proceso|length > 0 %}
                                                <div class="servicios-container">
                                                    <div class="servicios-indicator en-proceso">
                                                        <i class="bi bi-tools"></i>
                                                        {{ dia_data.servicios_en_proceso|length }} en proceso
                                                    </div>
                                                    <div class="servicios-tooltip">
                                                        <div style="font-weight: 700; margin-bottom: 0.5rem; color: #2c3e50;">
                                                            <i class="bi bi-tools"></i>
                                                            Servicios en Proceso
                                                        </div>
                                                        {% for servicio in dia_data.servicios_en_proceso %}
                                                            <a href="{% url 'gestionDeTaller:detalle_servicio' servicio.id %}" 
                                                               class="servicio-item-tooltip">
                                                                <div style="font-weight: 600;">
                                                                    #{{ servicio.id }} - {{ servicio.preorden.cliente.razon_social|truncatechars:25 }}
                                                                </div>
                                                                <div style="font-size: 0.7rem; opacity: 0.9;">
                                                                    {{ servicio.preorden.equipo.numero_serie|truncatechars:20 }}
                                                                </div>
                                                            </a>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                            {% endif %}
                                            
                                            {% comment %} Mostrar mensaje si no hay elementos {% endcomment %}
                                            {% if dia_data.preordenes|length == 0 and dia_data.servicios_programados|length == 0 and dia_data.servicios_en_proceso|length == 0 %}
                                                <div class="text-muted text-center" style="font-size: 0.8rem; padding: 1rem 0;">
                                                    <i class="bi bi-calendar-x"></i>
                                                    Sin elementos
                                                </div>
                                            {% endif %}
                                        {% endwith %}
                                    </div>
                                </td>
                            {% endwith %}
                        {% endfor %}
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="7" class="text-center py-5">
                            <i class="bi bi-people text-muted" style="font-size: 3rem;"></i>
                            <h5 class="mt-3 text-muted">No hay técnicos disponibles</h5>
                            <p class="text-muted">No se encontraron técnicos activos en el sistema.</p>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Botón volver -->
    <div class="text-center">
        <a href="{% url 'gestionDeTaller:calendario_preordenes' %}" class="btn-volver">
            <i class="bi bi-arrow-left"></i>
            Volver al Calendario General
        </a>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Agregar tooltips a las preórdenes
    const preordenItems = document.querySelectorAll('.calendario-item.preorden');
    
    preordenItems.forEach(function(item) {
        item.addEventListener('mouseenter', function(e) {
            const rect = this.getBoundingClientRect();
            const tooltip = document.createElement('div');
            tooltip.className = 'custom-tooltip';
            tooltip.style.position = 'absolute';
            tooltip.style.top = rect.bottom + window.scrollY + 5 + 'px';
            tooltip.style.left = rect.left + window.scrollX + 'px';
            tooltip.style.zIndex = '1000';
            tooltip.style.background = 'white';
            tooltip.style.border = '1px solid #e9ecef';
            tooltip.style.borderRadius = '8px';
            tooltip.style.padding = '0.5rem';
            tooltip.style.boxShadow = '0 4px 15px rgba(0,0,0,0.2)';
            tooltip.style.fontSize = '0.8rem';
            tooltip.style.maxWidth = '200px';
            
            const numero = this.querySelector('.item-numero').textContent;
            const cliente = this.querySelector('.item-cliente').textContent;
            const equipo = this.querySelector('.item-equipo').textContent;
            
            tooltip.innerHTML = `
                <strong>Preorden ${numero}</strong><br>
                <strong>Cliente:</strong> ${cliente}<br>
                <strong>Equipo:</strong> ${equipo}
            `;
            
            document.body.appendChild(tooltip);
            
            this.addEventListener('mouseleave', function() {
                if (tooltip && tooltip.parentNode) {
                    tooltip.parentNode.removeChild(tooltip);
                }
            });
        });
    });
    
    // Función para ajustar la dirección de los tooltips de servicios
    function adjustTooltipDirection() {
        const serviciosContainers = document.querySelectorAll('.servicios-container');
        
        serviciosContainers.forEach(function(container) {
            container.addEventListener('mouseenter', function() {
                const tooltip = this.querySelector('.servicios-tooltip');
                if (tooltip) {
                    const rect = this.getBoundingClientRect();
                    const tooltipHeight = 200; // Altura estimada del tooltip
                    const windowHeight = window.innerHeight;
                    const spaceBelow = windowHeight - rect.bottom;
                    
                    // Si no hay suficiente espacio abajo, mostrar hacia arriba
                    if (spaceBelow < tooltipHeight) {
                        tooltip.classList.add('tooltip-up');
                    } else {
                        tooltip.classList.remove('tooltip-up');
                    }
                }
            });
        });
    }
    
    // Ejecutar la función cuando se carga la página
    adjustTooltipDirection();
    
    // Re-ejecutar cuando se cambia el tamaño de la ventana
    window.addEventListener('resize', adjustTooltipDirection);
});
</script>
{% endblock %} 