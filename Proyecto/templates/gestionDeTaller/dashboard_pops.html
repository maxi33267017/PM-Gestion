{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard POPS - Percentage of Product Serviced{% endblock %}

{% block extra_css %}
<style>
    .pops-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .metric-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        transition: transform 0.2s;
    }
    
    .metric-card:hover {
        transform: translateY(-2px);
    }
    
    .metric-value {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .metric-label {
        color: #6c757d;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .pops-percentage {
        font-size: 3rem;
        font-weight: 800;
        color: #28a745;
    }
    
    .chart-container {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    
    .opportunity-item {
        border-left: 4px solid #ffc107;
        padding: 1rem;
        margin-bottom: 1rem;
        background: #f8f9fa;
        border-radius: 0 10px 10px 0;
    }
    
    .filter-section {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    
    .progress-bar-custom {
        height: 8px;
        border-radius: 4px;
        background: #e9ecef;
        overflow: hidden;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #28a745, #20c997);
        transition: width 0.3s ease;
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container-fluid">
    <!-- Header -->
    <div class="pops-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-2">
                    <i class="bi bi-graph-up me-3"></i>Dashboard POPS
                </h1>
                <p class="mb-0 lead">Percentage of Product Serviced - Análisis de equipos vendidos que regresan para servicios</p>
            </div>
            <div class="col-md-4 text-end">
                <div class="pops-percentage">{{ porcentaje_pops }}%</div>
                <div class="text-white-50">POPS Actual</div>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="filter-section">
        <div class="row">
            <div class="col-md-4">
                <label for="mes" class="form-label">Mes:</label>
                <select id="mes" name="mes" class="form-select">
                    <option value="">Todos los meses</option>
                    {% for mes in meses %}
                        <option value="{{ mes.valor }}" {% if mes.valor == mes_filtro %}selected{% endif %}>
                            {{ mes.nombre }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label for="año" class="form-label">Año:</label>
                <select id="año" name="año" class="form-select">
                    <option value="">Todos los años</option>
                    {% for año in años %}
                        <option value="{{ año }}" {% if año|stringformat:"s" == año_filtro %}selected{% endif %}>
                            {{ año }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4 d-flex align-items-end">
                <button type="button" class="btn btn-primary w-100" onclick="aplicarFiltros()">
                    <i class="bi bi-search me-2"></i>Aplicar Filtros
                </button>
            </div>
        </div>
    </div>

    <!-- Métricas Principales -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value text-primary">{{ total_equipos_vendidos }}</div>
                <div class="metric-label">Equipos Vendidos (10 años)</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value text-success">{{ equipos_con_servicios }}</div>
                <div class="metric-label">Con Servicios (último año)</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value text-warning">{{ equipos_sin_servicios }}</div>
                <div class="metric-label">Sin Servicios</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value text-info">{{ mes_analisis }}</div>
                <div class="metric-label">Período Analizado</div>
            </div>
        </div>
    </div>

    <!-- Gráficos -->
    <div class="row">
        <!-- POPS Mensual -->
        <div class="col-lg-8">
            <div class="chart-container">
                <h5 class="mb-3">
                    <i class="bi bi-bar-chart me-2"></i>POPS Mensual - Gráfico de Barras (Últimos 12 meses)
                </h5>

                
                <div style="height: 300px; position: relative;">
                    <canvas id="popsChart"></canvas>
                    <div id="chartFallback" style="display: none; text-align: center; padding: 50px;">
                        <i class="bi bi-exclamation-triangle fs-1 text-warning"></i>
                        <p class="mt-2">No se pudo cargar el gráfico. Verificando datos...</p>
                        <div id="dataDebug"></div>
                    </div>
                </div>
                
                <!-- Debug Visual de Datos -->
                <div class="alert alert-info mt-3">
                    <h6><i class="bi bi-bug me-2"></i>Debug: Datos que se envían al gráfico</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Labels:</strong>
                            <div class="small text-muted">
                                [{% for item in pops_mensual %}'{{ item.mes }}'{% if not forloop.last %}, {% endif %}{% endfor %}]
                            </div>
                        </div>
                        <div class="col-md-6">
                            <strong>Data:</strong>
                            <div class="small text-muted">
                                [{% for item in pops_mensual %}{{ item.pops }}{% if not forloop.last %}, {% endif %}{% endfor %}]
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tabla de Datos del Gráfico -->
                <div class="mt-4">
                    <h6 class="mb-3">
                        <i class="bi bi-table me-2"></i>Datos del Gráfico POPS Mensual
                    </h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped table-bordered">
                            <thead class="table-dark">
                                <tr>
                                    <th>#</th>
                                    <th>Mes</th>
                                    <th>POPS (%)</th>
                                    <th>Equipos Vendidos</th>
                                    <th>Equipos con Servicios</th>
                                    <th>Equipos sin Servicios</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in pops_mensual %}
                                <tr>
                                    <td>{{ forloop.counter }}</td>
                                    <td><strong>{{ item.mes }}</strong></td>
                                    <td>
                                        <span class="badge bg-primary fs-6">{{ item.pops }}%</span>
                                    </td>
                                    <td>{{ item.equipos_vendidos }}</td>
                                    <td>{{ item.equipos_con_servicios }}</td>
                                    <td>{{ item.equipos_sin_servicios }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- POPS por Tipo de Equipo -->
        <div class="col-lg-4">
            <div class="chart-container">
                <h5 class="mb-3">
                    <i class="bi bi-pie-chart me-2"></i>POPS por Tipo de Equipo
                </h5>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Tipo</th>
                                <th>POPS</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for tipo in pops_por_tipo %}
                            <tr>
                                <td>{{ tipo.tipo }}</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <span class="badge bg-success me-2">{{ tipo.pops }}%</span>
                                        <div class="progress-bar-custom flex-grow-1">
                                            <div class="progress-fill" style="width: {{ tipo.pops }}%"></div>
                                        </div>
                                    </div>
                                </td>
                                <td>{{ tipo.total_equipos }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla POPS Mensual Detallada -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="chart-container">
                <h5 class="mb-3">
                    <i class="bi bi-table me-2"></i>POPS Mensual Detallado (Últimos 12 meses)
                </h5>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Mes</th>
                                <th>Equipos Vendidos (10 años)</th>
                                <th>Equipos con Servicios (1 año)</th>
                                <th>Equipos Sin Servicios</th>
                                <th>POPS (%)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in pops_mensual %}
                            <tr>
                                <td><strong>{{ item.mes }}</strong></td>
                                <td class="text-center">
                                    <span class="badge bg-primary">{{ item.equipos_vendidos }}</span>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-success">{{ item.equipos_con_servicios }}</span>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-warning">{{ item.equipos_sin_servicios }}</span>
                                </td>
                                <td class="text-center">
                                    <span class="badge {% if item.pops >= 50 %}bg-success{% elif item.pops >= 25 %}bg-warning{% else %}bg-danger{% endif %} fs-6">
                                        {{ item.pops }}%
                                    </span>
                                </td>

                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                

            </div>
        </div>
    </div>
    </div>

    <!-- Oportunidades y Embudos -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="chart-container">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">
                        <i class="bi bi-exclamation-triangle me-2"></i>Oportunidades - Equipos Sin Servicios
                    </h5>
                    {% if equipos_sin_servicios_list %}
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-success btn-sm" onclick="crearEmbudo('todos')">
                            <i class="bi bi-funnel me-1"></i>Crear Embudo (Todos)
                        </button>
                        <button type="button" class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#modalEmbudoTipo">
                            <i class="bi bi-funnel me-1"></i>Por Tipo
                        </button>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Filtros de oportunidades -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <select id="filtroTipoOportunidad" class="form-select form-select-sm" onchange="filtrarOportunidades()">
                            <option value="">Todos los tipos</option>
                            {% for tipo in pops_por_tipo %}
                                <option value="{{ tipo.tipo }}">{{ tipo.tipo }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="text" id="buscarOportunidad" class="form-control form-control-sm" placeholder="Buscar por PIN o cliente..." onkeyup="filtrarOportunidades()">
                    </div>
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="seleccionarTodos" onchange="seleccionarTodosOportunidades()">
                            <label class="form-check-label" for="seleccionarTodos">
                                Seleccionar todos
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="row" id="oportunidadesContainer">
                    {% for equipo in equipos_sin_servicios_list %}
                    <div class="col-md-6 col-lg-4 oportunidad-item" data-tipo="{{ equipo.modelo.tipo_equipo.nombre }}" data-pin="{{ equipo.numero_serie }}" data-cliente="{{ equipo.cliente.razon_social }}">
                        <div class="opportunity-item">
                            <div class="form-check">
                                <input class="form-check-input oportunidad-checkbox" type="checkbox" value="{{ equipo.id }}" id="oportunidad_{{ equipo.id }}">
                            </div>
                            <div class="fw-bold">{{ equipo.numero_serie }}</div>
                            <div class="text-muted">{{ equipo.modelo.tipo_equipo.nombre }} - {{ equipo.modelo.nombre }}</div>
                            <div class="small">{{ equipo.cliente.razon_social }}</div>
                            <div class="small text-muted">Vendido: {{ equipo.fecha_venta|date:"d/m/Y" }}</div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-12">
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-check-circle fs-1"></i>
                            <p class="mt-2">¡Excelente! Todos los equipos tienen servicios registrados.</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                {% if equipos_sin_servicios_list %}
                <div class="row mt-3">
                    <div class="col-12">
                        <button type="button" class="btn btn-primary" onclick="crearEmbudoSeleccionados()" id="btnCrearEmbudoSeleccionados" disabled>
                            <i class="bi bi-funnel me-2"></i>Crear Embudo con Seleccionados (<span id="contadorSeleccionados">0</span>)
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Embudos POPS Existentes -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="chart-container">
                <h5 class="mb-3">
                    <i class="bi bi-funnel me-2"></i>Embudos POPS Existentes
                </h5>
                {% if embudos_pops %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Embudo</th>
                                <th>Cliente</th>
                                <th>Etapa</th>
                                <th>Oportunidades</th>
                                <th>Fecha Creación</th>
                                <th>Creado por</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for embudo in embudos_pops %}
                            <tr>
                                <td>
                                    <strong>{{ embudo.descripcion_negocio|truncatechars:50 }}</strong>
                                </td>
                                <td>{{ embudo.cliente.razon_social|truncatechars:30 }}</td>
                                <td>
                                    <span class="badge {% if embudo.etapa == 'CONTACTO_INICIAL' %}bg-primary{% elif embudo.etapa == 'CALIFICACION' %}bg-info{% elif embudo.etapa == 'PROPUESTA' %}bg-warning{% elif embudo.etapa == 'NEGOCIACION' %}bg-secondary{% elif embudo.etapa == 'CIERRE' %}bg-success{% else %}bg-danger{% endif %}">
                                        {{ embudo.get_etapa_display }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge bg-info">{{ embudo.contactos.count }}</span>
                                </td>
                                <td>{{ embudo.fecha_creacion|date:"d/m/Y H:i" }}</td>
                                <td>{{ embudo.creado_por.get_full_name|default:embudo.creado_por.username }}</td>
                                <td>
                                    <a href="{% url 'crm:embudo_ventas_detalle' embudo.id %}" class="btn btn-sm btn-primary">
                                        <i class="bi bi-eye me-1"></i>Ver
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-muted py-4">
                    <i class="bi bi-funnel fs-1"></i>
                    <p class="mt-2">No hay embudos POPS creados aún.</p>
                    <p class="small">Crea tu primer embudo usando los botones de arriba.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<script>
    // Función para obtener datos de la tabla

    
    // Variables globales para los datos del gráfico
    let popsChartData = {
        labels: [{% for item in pops_mensual %}'{{ item.mes }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
        data: [{% for item in pops_mensual %}{{ item.pops }}{% if not forloop.last %}, {% endif %}{% endfor %}].map(val => parseFloat(val.toString().replace(',', '.')))
    };
    
    // Debug inmediato de los datos del gráfico
    console.log('=== DATOS INMEDIATOS DEL GRÁFICO ===');
    console.log('popsChartData.labels:', popsChartData.labels);
    console.log('popsChartData.data:', popsChartData.data);
    console.log('Datos del template Django:');
    {% for item in pops_mensual %}
    console.log('{{ item.mes }}: {{ item.pops }}%');
    {% endfor %}
    
    // Debug específico para Junio 2025
    console.log('=== DEBUG JUNIO 2025 ===');
    const junioIndex = popsChartData.labels.findIndex(label => label.includes('Junio 2025'));
    if (junioIndex !== -1) {
        console.log(`Junio 2025 encontrado en índice ${junioIndex}`);
        console.log(`Valor en el gráfico: ${popsChartData.data[junioIndex]}%`);
        console.log(`Label: ${popsChartData.labels[junioIndex]}`);
    } else {
        console.log('Junio 2025 NO encontrado en los labels');
    }
    
    // Función para inicializar el gráfico
    function inicializarGrafico() {
        // Usar los datos globales
        const popsData = {
            labels: popsChartData.labels,
            datasets: [{
                label: 'POPS (%)',
                data: popsChartData.data,
                backgroundColor: 'rgba(40, 167, 69, 0.8)',
                borderColor: 'rgba(40, 167, 69, 1)',
                borderWidth: 1,
                borderRadius: 4,
                borderSkipped: false
            }]
        };
        
        // Debug: mostrar datos
        console.log('=== DATOS POPS DEL GRÁFICO ===');
        console.log('Labels:', popsData.labels);
        console.log('Data:', popsData.datasets[0].data);
        
        // Debug detallado de cada punto
        console.log('=== PUNTOS DEL GRÁFICO ===');
        for (let i = 0; i < popsData.labels.length; i++) {
            console.log(`${i}: ${popsData.labels[i]} = ${popsData.datasets[0].data[i]}%`);
        }
        

        
        // Crear el gráfico
        const ctx = document.getElementById('popsChart');
        if (ctx && popsData.datasets[0].data.length > 0) {
            const chartCtx = ctx.getContext('2d');
            try {
                new Chart(chartCtx, {
                    type: 'bar',
                    data: popsData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 2,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'POPS: ' + context.parsed.y + '%';
                                    }
                                }
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        elements: {
                            bar: {
                                borderRadius: 4,
                                borderSkipped: false
                            }
                        }
                    }
                });
                console.log('Gráfico creado exitosamente');
            } catch (error) {
                console.error('Error al crear el gráfico:', error);
            }
        } else {
            console.error('No se pudo encontrar el canvas o no hay datos');
        }
    }
    

    
    // Inicializar cuando el DOM esté listo
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar el gráfico
        inicializarGrafico();
        
        // Comparar datos de la tabla con el gráfico
        console.log('=== COMPARACIÓN DATOS TABLA vs GRÁFICO ===');
        
        // Obtener datos de la tabla
        const tablaPOPS = document.querySelector('.chart-container table tbody');
        if (tablaPOPS) {
            const tablaRows = tablaPOPS.querySelectorAll('tr');
            tablaRows.forEach((row, index) => {
                if (row.cells.length < 5) return;
                const mesTabla = row.cells[0].textContent.trim();
                const popsTabla = parseFloat(row.cells[4].textContent.replace('%', ''));
                const popsGrafico = popsChartData.data[index];
                
                console.log(`${mesTabla}: Tabla=${popsTabla}%, Gráfico=${popsGrafico}%`);
                
                if (popsTabla !== popsGrafico) {
                    console.warn(`⚠️ DISCREPANCIA en ${mesTabla}: Tabla=${popsTabla}%, Gráfico=${popsGrafico}%`);
                } else {
                    console.log(`✅ ${mesTabla}: ${popsTabla}% (coincide)`);
                }
            });
        }
    });

    // Verificar que Chart.js se cargó correctamente
    if (typeof Chart === 'undefined') {
        console.error('Chart.js no se cargó correctamente');
    } else {
        console.log('Chart.js cargado correctamente');
    }

    // Función para aplicar filtros
    function aplicarFiltros() {
        const mes = document.getElementById('mes').value;
        const año = document.getElementById('año').value;
        
        let url = '{% url "gestionDeTaller:dashboard_pops" %}?';
        const params = [];
        
        if (mes) params.push('mes=' + mes);
        if (año) params.push('año=' + año);
        
        if (params.length > 0) {
            url += params.join('&');
        }
        
        window.location.href = url;
    }
    
    // Funciones para filtros de oportunidades
    function filtrarOportunidades() {
        const filtroTipo = document.getElementById('filtroTipoOportunidad').value.toLowerCase();
        const busqueda = document.getElementById('buscarOportunidad').value.toLowerCase();
        const items = document.querySelectorAll('.oportunidad-item');
        
        items.forEach(item => {
            const tipo = item.dataset.tipo.toLowerCase();
            const pin = item.dataset.pin.toLowerCase();
            const cliente = item.dataset.cliente.toLowerCase();
            
            const coincideTipo = !filtroTipo || tipo.includes(filtroTipo);
            const coincideBusqueda = !busqueda || pin.includes(busqueda) || cliente.includes(busqueda);
            
            if (coincideTipo && coincideBusqueda) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }
    
    function seleccionarTodosOportunidades() {
        const seleccionarTodos = document.getElementById('seleccionarTodos');
        const checkboxes = document.querySelectorAll('.oportunidad-checkbox:not([style*="display: none"])');
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = seleccionarTodos.checked;
        });
        
        actualizarContadorSeleccionados();
    }
    
    function actualizarContadorSeleccionados() {
        const checkboxes = document.querySelectorAll('.oportunidad-checkbox:checked');
        const contador = document.getElementById('contadorSeleccionados');
        const btnCrear = document.getElementById('btnCrearEmbudoSeleccionados');
        
        contador.textContent = checkboxes.length;
        btnCrear.disabled = checkboxes.length === 0;
    }
    
    // Event listeners para checkboxes
    document.addEventListener('DOMContentLoaded', function() {
        const checkboxes = document.querySelectorAll('.oportunidad-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', actualizarContadorSeleccionados);
        });
    });
    
    // Funciones para crear embudos
    function crearEmbudo(tipo) {
        let equiposIds = [];
        
        if (tipo === 'todos') {
            // Para "todos" no necesitamos enviar IDs, la vista los obtendrá de la BD
            equiposIds = [];
        } else if (tipo === 'seleccionados') {
            const checkboxes = document.querySelectorAll('.oportunidad-checkbox:checked');
            checkboxes.forEach(checkbox => {
                equiposIds.push(checkbox.value);
            });
        }
        
        if (tipo === 'seleccionados' && equiposIds.length === 0) {
            alert('No hay equipos seleccionados para crear el embudo.');
            return;
        }
        
        // Crear el embudo via AJAX
        fetch('{% url "crm:crear_embudo_pops" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                tipo: tipo,
                equipos_ids: equiposIds,
                nombre: 'Campaña POPS - ' + new Date().toLocaleDateString(),
                descripcion: 'Campaña creada desde dashboard POPS con equipos sin servicios'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Embudo POPS creado exitosamente con ' + data.oportunidades_creadas + ' oportunidades.');
                window.location.href = data.redirect_url;
            } else {
                alert('Error al crear el embudo: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al crear el embudo.');
        });
    }
    
    function crearEmbudoSeleccionados() {
        crearEmbudo('seleccionados');
    }
    
    function crearEmbudoPorTipo() {
        const tipo = document.getElementById('tipoEmbudo').value;
        const nombre = document.getElementById('nombreEmbudo').value;
        const descripcion = document.getElementById('descripcionEmbudo').value;
        
        if (!nombre.trim()) {
            alert('Por favor ingrese un nombre para la campaña.');
            return;
        }
        
        // Crear la campaña por tipo
        fetch('{% url "crm:crear_embudo_pops" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                tipo: 'por_tipo',
                tipo_equipo: tipo,
                nombre: nombre,
                descripcion: descripcion
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Embudo POPS creado exitosamente con ' + data.oportunidades_creadas + ' oportunidades.');
                window.location.href = data.redirect_url;
            } else {
                alert('Error al crear el embudo: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al crear el embudo.');
        });
        
        // Cerrar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalEmbudoTipo'));
        modal.hide();
    }
</script>

<!-- Modal para crear embudo por tipo -->
<div class="modal fade" id="modalEmbudoTipo" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Crear Embudo por Tipo de Equipo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="tipoEmbudo" class="form-label">Tipo de Equipo:</label>
                    <select id="tipoEmbudo" class="form-select">
                        {% for tipo in pops_por_tipo %}
                            <option value="{{ tipo.tipo }}">{{ tipo.tipo }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label for="nombreEmbudo" class="form-label">Nombre del Embudo:</label>
                    <input type="text" id="nombreEmbudo" class="form-control" placeholder="Ej: Embudo POPS - Retroexcavadoras">
                </div>
                <div class="mb-3">
                    <label for="descripcionEmbudo" class="form-label">Descripción:</label>
                    <textarea id="descripcionEmbudo" class="form-control" rows="3" placeholder="Descripción del embudo..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="crearEmbudoPorTipo()">Crear Embudo</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
