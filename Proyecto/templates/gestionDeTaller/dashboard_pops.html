{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard POPS - Percentage of Product Serviced{% endblock %}

{% block extra_css %}
<style>
    .pops-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .metric-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        transition: transform 0.2s;
    }
    
    .metric-card:hover {
        transform: translateY(-2px);
    }
    
    .metric-value {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .metric-label {
        color: #6c757d;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .pops-percentage {
        font-size: 3rem;
        font-weight: 800;
        color: #28a745;
    }
    
    .chart-container {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    
    .opportunity-item {
        border-left: 4px solid #ffc107;
        padding: 1rem;
        margin-bottom: 1rem;
        background: #f8f9fa;
        border-radius: 0 10px 10px 0;
    }
    
    .filter-section {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    
    .progress-bar-custom {
        height: 8px;
        border-radius: 4px;
        background: #e9ecef;
        overflow: hidden;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #28a745, #20c997);
        transition: width 0.3s ease;
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container-fluid">
    <!-- Header -->
    <div class="pops-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-2">
                    <i class="bi bi-graph-up me-3"></i>Dashboard POPS
                </h1>
                <p class="mb-0 lead">Percentage of Product Serviced - Análisis de equipos vendidos que regresan para servicios</p>
            </div>
            <div class="col-md-4 text-end">
                <div class="pops-percentage">{{ porcentaje_pops }}%</div>
                <div class="text-white-50">POPS Actual</div>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="filter-section">
        <div class="row">
            <div class="col-md-4">
                <label for="mes" class="form-label">Mes:</label>
                <select id="mes" name="mes" class="form-select">
                    <option value="">Todos los meses</option>
                    {% for mes in meses %}
                        <option value="{{ mes.valor }}" {% if mes.valor == mes_filtro %}selected{% endif %}>
                            {{ mes.nombre }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label for="año" class="form-label">Año:</label>
                <select id="año" name="año" class="form-select">
                    <option value="">Todos los años</option>
                    {% for año in años %}
                        <option value="{{ año }}" {% if año|stringformat:"s" == año_filtro %}selected{% endif %}>
                            {{ año }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4 d-flex align-items-end">
                <button type="button" class="btn btn-primary w-100" onclick="aplicarFiltros()">
                    <i class="bi bi-search me-2"></i>Aplicar Filtros
                </button>
            </div>
        </div>
    </div>

    <!-- Métricas Principales -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value text-primary">{{ total_equipos_vendidos }}</div>
                <div class="metric-label">Equipos Vendidos (10 años)</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value text-success">{{ equipos_con_servicios }}</div>
                <div class="metric-label">Con Servicios (último año)</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value text-warning">{{ equipos_sin_servicios }}</div>
                <div class="metric-label">Sin Servicios</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value text-info">{{ mes_analisis }}</div>
                <div class="metric-label">Período Analizado</div>
            </div>
        </div>
    </div>

    <!-- Gráficos -->
    <div class="row">
        <!-- POPS Mensual -->
        <div class="col-lg-8">
            <div class="chart-container">
                <h5 class="mb-3">
                    <i class="bi bi-bar-chart me-2"></i>POPS Mensual (Últimos 12 meses)
                </h5>
                <div style="height: 300px; position: relative;">
                    <canvas id="popsChart"></canvas>
                    <div id="chartFallback" style="display: none; text-align: center; padding: 50px;">
                        <i class="bi bi-exclamation-triangle fs-1 text-warning"></i>
                        <p class="mt-2">No se pudo cargar el gráfico. Verificando datos...</p>
                        <div id="dataDebug"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- POPS por Tipo de Equipo -->
        <div class="col-lg-4">
            <div class="chart-container">
                <h5 class="mb-3">
                    <i class="bi bi-pie-chart me-2"></i>POPS por Tipo de Equipo
                </h5>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Tipo</th>
                                <th>POPS</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for tipo in pops_por_tipo %}
                            <tr>
                                <td>{{ tipo.tipo }}</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <span class="badge bg-success me-2">{{ tipo.pops }}%</span>
                                        <div class="progress-bar-custom flex-grow-1">
                                            <div class="progress-fill" style="width: {{ tipo.pops }}%"></div>
                                        </div>
                                    </div>
                                </td>
                                <td>{{ tipo.total_equipos }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla POPS Mensual Detallada -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="chart-container">
                <h5 class="mb-3">
                    <i class="bi bi-table me-2"></i>POPS Mensual Detallado (Últimos 12 meses)
                </h5>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Mes</th>
                                <th>Equipos Vendidos (10 años)</th>
                                <th>Equipos con Servicios (1 año)</th>
                                <th>Equipos Sin Servicios</th>
                                <th>POPS (%)</th>
                                <th>Debug Info</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in pops_mensual %}
                            <tr>
                                <td><strong>{{ item.mes }}</strong></td>
                                <td class="text-center">
                                    <span class="badge bg-primary">{{ item.equipos_vendidos }}</span>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-success">{{ item.equipos_con_servicios }}</span>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-warning">{{ item.equipos_sin_servicios }}</span>
                                </td>
                                <td class="text-center">
                                    <span class="badge {% if item.pops >= 50 %}bg-success{% elif item.pops >= 25 %}bg-warning{% else %}bg-danger{% endif %} fs-6">
                                        {{ item.pops }}%
                                    </span>
                                </td>
                                <td class="small text-muted">
                                    <div><strong>Fecha:</strong> {{ item.fecha|date:"d/m/Y" }}</div>
                                    <div><strong>Ventas:</strong> {{ item.debug_info.fecha_inicio_ventas|date:"d/m/Y" }} - {{ item.debug_info.fecha_fin_ventas|date:"d/m/Y" }}</div>
                                    <div><strong>Servicios:</strong> {{ item.debug_info.fecha_inicio_servicios|date:"d/m/Y" }} - {{ item.debug_info.fecha_fin_servicios|date:"d/m/Y" }}</div>
                                    <div><strong>PINs:</strong> {{ item.debug_info.pines_vendidos_count }} vendidos, {{ item.debug_info.pines_con_servicios_count }} con servicios</div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Resumen de datos -->
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="alert alert-info">
                            <h6><i class="bi bi-info-circle me-2"></i>Información del Gráfico</h6>
                            <div class="small">
                                <strong>Datos enviados al gráfico:</strong><br>
                                <span id="chartDataDebug"></span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="alert alert-warning">
                            <h6><i class="bi bi-exclamation-triangle me-2"></i>Verificación de Datos</h6>
                            <div class="small">
                                <strong>Total de registros:</strong> {{ pops_mensual|length }}<br>
                                <strong>Rango de POPS:</strong> {{ pops_mensual|first|first|pops|floatformat:1 }}% - {{ pops_mensual|last|first|pops|floatformat:1 }}%<br>
                                <strong>Promedio POPS:</strong> <span id="promedioPops"></span>%
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Oportunidades y Embudos -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="chart-container">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">
                        <i class="bi bi-exclamation-triangle me-2"></i>Oportunidades - Equipos Sin Servicios
                    </h5>
                    {% if equipos_sin_servicios_list %}
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-success btn-sm" onclick="crearEmbudo('todos')">
                            <i class="bi bi-funnel me-1"></i>Crear Embudo (Todos)
                        </button>
                        <button type="button" class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#modalEmbudoTipo">
                            <i class="bi bi-funnel me-1"></i>Por Tipo
                        </button>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Filtros de oportunidades -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <select id="filtroTipoOportunidad" class="form-select form-select-sm" onchange="filtrarOportunidades()">
                            <option value="">Todos los tipos</option>
                            {% for tipo in pops_por_tipo %}
                                <option value="{{ tipo.tipo }}">{{ tipo.tipo }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="text" id="buscarOportunidad" class="form-control form-control-sm" placeholder="Buscar por PIN o cliente..." onkeyup="filtrarOportunidades()">
                    </div>
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="seleccionarTodos" onchange="seleccionarTodosOportunidades()">
                            <label class="form-check-label" for="seleccionarTodos">
                                Seleccionar todos
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="row" id="oportunidadesContainer">
                    {% for equipo in equipos_sin_servicios_list %}
                    <div class="col-md-6 col-lg-4 oportunidad-item" data-tipo="{{ equipo.modelo.tipo_equipo.nombre }}" data-pin="{{ equipo.numero_serie }}" data-cliente="{{ equipo.cliente.razon_social }}">
                        <div class="opportunity-item">
                            <div class="form-check">
                                <input class="form-check-input oportunidad-checkbox" type="checkbox" value="{{ equipo.id }}" id="oportunidad_{{ equipo.id }}">
                            </div>
                            <div class="fw-bold">{{ equipo.numero_serie }}</div>
                            <div class="text-muted">{{ equipo.modelo.tipo_equipo.nombre }} - {{ equipo.modelo.nombre }}</div>
                            <div class="small">{{ equipo.cliente.razon_social }}</div>
                            <div class="small text-muted">Vendido: {{ equipo.fecha_venta|date:"d/m/Y" }}</div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-12">
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-check-circle fs-1"></i>
                            <p class="mt-2">¡Excelente! Todos los equipos tienen servicios registrados.</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                {% if equipos_sin_servicios_list %}
                <div class="row mt-3">
                    <div class="col-12">
                        <button type="button" class="btn btn-primary" onclick="crearEmbudoSeleccionados()" id="btnCrearEmbudoSeleccionados" disabled>
                            <i class="bi bi-funnel me-2"></i>Crear Embudo con Seleccionados (<span id="contadorSeleccionados">0</span>)
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<script>
    // Datos para el gráfico - usando JSON seguro
    const popsData = {
        labels: [
            {% for item in pops_mensual %}
                '{{ item.mes|escapejs }}'{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        datasets: [{
            label: 'POPS (%)',
            data: [
                {% for item in pops_mensual %}
                    {{ item.pops|default:0 }}{% if not forloop.last %},{% endif %}
                {% endfor %}
            ],
            backgroundColor: 'rgba(40, 167, 69, 0.2)',
            borderColor: 'rgba(40, 167, 69, 1)',
            borderWidth: 2,
            tension: 0.4
        }]
    };
    
    // Debug: mostrar datos en consola
    console.log('Datos POPS mensual:', popsData);
    
    // Mostrar datos de debug en la página
    document.addEventListener('DOMContentLoaded', function() {
        // Debug del gráfico
        const chartDataDebug = document.getElementById('chartDataDebug');
        if (chartDataDebug) {
            let debugText = '';
            for (let i = 0; i < popsData.labels.length; i++) {
                debugText += `${popsData.labels[i]}: ${popsData.datasets[0].data[i]}%<br>`;
            }
            chartDataDebug.innerHTML = debugText;
        }
        
        // Calcular promedio POPS
        const promedioPops = document.getElementById('promedioPops');
        if (promedioPops && popsData.datasets[0].data.length > 0) {
            const suma = popsData.datasets[0].data.reduce((a, b) => a + b, 0);
            const promedio = (suma / popsData.datasets[0].data.length).toFixed(1);
            promedioPops.textContent = promedio;
        }
        
        // Comparar datos de la tabla con el gráfico
        console.log('=== COMPARACIÓN DATOS TABLA vs GRÁFICO ===');
        const tablaRows = document.querySelectorAll('tbody tr');
        tablaRows.forEach((row, index) => {
            const mesTabla = row.cells[0].textContent.trim();
            const popsTabla = parseFloat(row.cells[4].textContent.replace('%', ''));
            const popsGrafico = popsData.datasets[0].data[index];
            
            if (popsTabla !== popsGrafico) {
                console.warn(`⚠️ DISCREPANCIA en ${mesTabla}: Tabla=${popsTabla}%, Gráfico=${popsGrafico}%`);
            } else {
                console.log(`✅ ${mesTabla}: ${popsTabla}% (coincide)`);
            }
        });
    });

    // Verificar que Chart.js se cargó correctamente
    if (typeof Chart === 'undefined') {
        console.error('Chart.js no se cargó correctamente');
    } else {
        console.log('Chart.js cargado correctamente');
        
        // Configuración del gráfico
        const ctx = document.getElementById('popsChart');
        if (ctx) {
            const chartCtx = ctx.getContext('2d');
            try {
                new Chart(chartCtx, {
                    type: 'line',
                    data: popsData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 2,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'POPS: ' + context.parsed.y + '%';
                                    }
                                }
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        elements: {
                            point: {
                                radius: 4,
                                hoverRadius: 6
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error al crear el gráfico:', error);
            }
        } else {
            console.error('No se pudo encontrar el elemento canvas para el gráfico');
        }
    }

    // Función para aplicar filtros
    function aplicarFiltros() {
        const mes = document.getElementById('mes').value;
        const año = document.getElementById('año').value;
        
        let url = '{% url "gestionDeTaller:dashboard_pops" %}?';
        const params = [];
        
        if (mes) params.push('mes=' + mes);
        if (año) params.push('año=' + año);
        
        if (params.length > 0) {
            url += params.join('&');
        }
        
        window.location.href = url;
    }
    
    // Funciones para filtros de oportunidades
    function filtrarOportunidades() {
        const filtroTipo = document.getElementById('filtroTipoOportunidad').value.toLowerCase();
        const busqueda = document.getElementById('buscarOportunidad').value.toLowerCase();
        const items = document.querySelectorAll('.oportunidad-item');
        
        items.forEach(item => {
            const tipo = item.dataset.tipo.toLowerCase();
            const pin = item.dataset.pin.toLowerCase();
            const cliente = item.dataset.cliente.toLowerCase();
            
            const coincideTipo = !filtroTipo || tipo.includes(filtroTipo);
            const coincideBusqueda = !busqueda || pin.includes(busqueda) || cliente.includes(busqueda);
            
            if (coincideTipo && coincideBusqueda) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }
    
    function seleccionarTodosOportunidades() {
        const seleccionarTodos = document.getElementById('seleccionarTodos');
        const checkboxes = document.querySelectorAll('.oportunidad-checkbox:not([style*="display: none"])');
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = seleccionarTodos.checked;
        });
        
        actualizarContadorSeleccionados();
    }
    
    function actualizarContadorSeleccionados() {
        const checkboxes = document.querySelectorAll('.oportunidad-checkbox:checked');
        const contador = document.getElementById('contadorSeleccionados');
        const btnCrear = document.getElementById('btnCrearEmbudoSeleccionados');
        
        contador.textContent = checkboxes.length;
        btnCrear.disabled = checkboxes.length === 0;
    }
    
    // Event listeners para checkboxes
    document.addEventListener('DOMContentLoaded', function() {
        const checkboxes = document.querySelectorAll('.oportunidad-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', actualizarContadorSeleccionados);
        });
    });
    
    // Funciones para crear embudos
    function crearEmbudo(tipo) {
        let equiposIds = [];
        
        if (tipo === 'todos') {
            // Para "todos" no necesitamos enviar IDs, la vista los obtendrá de la BD
            equiposIds = [];
        } else if (tipo === 'seleccionados') {
            const checkboxes = document.querySelectorAll('.oportunidad-checkbox:checked');
            checkboxes.forEach(checkbox => {
                equiposIds.push(checkbox.value);
            });
        }
        
        if (tipo === 'seleccionados' && equiposIds.length === 0) {
            alert('No hay equipos seleccionados para crear el embudo.');
            return;
        }
        
        // Crear el embudo via AJAX
        fetch('{% url "crm:crear_embudo_pops" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                tipo: tipo,
                equipos_ids: equiposIds,
                nombre: 'Campaña POPS - ' + new Date().toLocaleDateString(),
                descripcion: 'Campaña creada desde dashboard POPS con equipos sin servicios'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Campaña creada exitosamente con ' + data.embudos_creados + ' embudos de clientes.');
                window.location.href = data.redirect_url;
            } else {
                alert('Error al crear la campaña: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al crear la campaña.');
        });
    }
    
    function crearEmbudoSeleccionados() {
        crearEmbudo('seleccionados');
    }
    
    function crearEmbudoPorTipo() {
        const tipo = document.getElementById('tipoEmbudo').value;
        const nombre = document.getElementById('nombreEmbudo').value;
        const descripcion = document.getElementById('descripcionEmbudo').value;
        
        if (!nombre.trim()) {
            alert('Por favor ingrese un nombre para la campaña.');
            return;
        }
        
        // Crear la campaña por tipo
        fetch('{% url "crm:crear_embudo_pops" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                tipo: 'por_tipo',
                tipo_equipo: tipo,
                nombre: nombre,
                descripcion: descripcion
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Campaña creada exitosamente con ' + data.embudos_creados + ' embudos de clientes.');
                window.location.href = data.redirect_url;
            } else {
                alert('Error al crear la campaña: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al crear la campaña.');
        });
        
        // Cerrar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalEmbudoTipo'));
        modal.hide();
    }
</script>

<!-- Modal para crear embudo por tipo -->
<div class="modal fade" id="modalEmbudoTipo" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Crear Embudo por Tipo de Equipo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="tipoEmbudo" class="form-label">Tipo de Equipo:</label>
                    <select id="tipoEmbudo" class="form-select">
                        {% for tipo in pops_por_tipo %}
                            <option value="{{ tipo.tipo }}">{{ tipo.tipo }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label for="nombreEmbudo" class="form-label">Nombre del Embudo:</label>
                    <input type="text" id="nombreEmbudo" class="form-control" placeholder="Ej: Embudo POPS - Retroexcavadoras">
                </div>
                <div class="mb-3">
                    <label for="descripcionEmbudo" class="form-label">Descripción:</label>
                    <textarea id="descripcionEmbudo" class="form-control" rows="3" placeholder="Descripción del embudo..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="crearEmbudoPorTipo()">Crear Embudo</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
