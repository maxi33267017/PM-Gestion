{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
    :root {
        --jd-black: #000000;
        --jd-black-dark: #1a1a1a;
        --jd-yellow: #ffd700;
        --jd-yellow-dark: #e6c200;
        --jd-orange: #ff8c00;
        --jd-gray: #2c3e50;
        --jd-light-gray: #ecf0f1;
        --jd-white: #ffffff;
    }
    
    .checklist-header {
        background: linear-gradient(135deg, var(--jd-black) 0%, var(--jd-black-dark) 100%);
        color: var(--jd-white);
        padding: 2rem;
        border-radius: 15px;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        position: relative;
        overflow: hidden;
    }
    
    .checklist-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="deere" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse"><circle cx="10" cy="10" r="2" fill="rgba(255,215,0,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23deere)"/></svg>');
        opacity: 0.3;
        animation: float 20s ease-in-out infinite;
    }
    
    @keyframes float {
        0%, 100% { transform: translateY(0px) rotate(0deg); }
        50% { transform: translateY(-20px) rotate(180deg); }
    }
    
    .checklist-header h1 {
        margin: 0;
        font-weight: 700;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        position: relative;
        z-index: 2;
    }
    
    .jd-logo {
        display: inline-block;
        width: 40px;
        height: 40px;
        background: var(--jd-yellow);
        border-radius: 50%;
        margin-right: 15px;
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: var(--jd-black);
        font-size: 12px;
    }
    
    .info-card {
        background: var(--jd-white);
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        padding: 1.5rem;
        margin-bottom: 2rem;
        border-left: 5px solid var(--jd-black);
    }
    
    .info-card h3 {
        color: var(--jd-black);
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--jd-light-gray);
        display: flex;
        align-items: center;
    }
    
    .progress-steps {
        background: var(--jd-white);
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        padding: 1.5rem;
        margin-bottom: 2rem;
        border-left: 5px solid var(--jd-yellow);
    }
    
    .step-indicator {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        position: relative;
    }
    
    .step-indicator::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--jd-light-gray);
        z-index: 1;
    }
    
    .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        z-index: 2;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .step-circle {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: var(--jd-white);
        border: 3px solid var(--jd-light-gray);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: var(--jd-gray);
        margin-bottom: 0.5rem;
        transition: all 0.3s ease;
    }
    
    .step.active .step-circle {
        background: var(--jd-yellow);
        border-color: var(--jd-black);
        color: var(--jd-black);
        transform: scale(1.1);
    }
    
    .step.completed .step-circle {
        background: var(--jd-black);
        border-color: var(--jd-black);
        color: var(--jd-white);
    }
    
    .step-label {
        font-size: 0.8rem;
        font-weight: 600;
        text-align: center;
        color: var(--jd-gray);
        max-width: 80px;
    }
    
    .step.active .step-label {
        color: var(--jd-black);
    }
    
    .step.completed .step-label {
        color: var(--jd-black);
    }
    
    .step-section {
        display: none;
        animation: fadeIn 0.5s ease;
    }
    
    .step-section.active {
        display: block;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .section-header {
        background: linear-gradient(135deg, var(--jd-black) 0%, var(--jd-black-dark) 100%);
        color: var(--jd-white);
        padding: 1.5rem;
        border-radius: 15px;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
    }
    
    .section-header::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background: var(--jd-yellow);
    }
    
    .section-header h2 {
        margin: 0;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .section-progress {
        background: var(--jd-light-gray);
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 2rem;
        border: 2px solid var(--jd-black);
    }
    
    .elemento-item {
        background: var(--jd-white);
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        padding: 1rem;
        margin-bottom: 0.75rem;
        border: 2px solid transparent;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .elemento-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--jd-yellow) 0%, var(--jd-black) 100%);
    }
    
    .elemento-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.12);
        border-color: var(--jd-yellow);
    }
    
    .elemento-nombre {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--jd-black);
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--jd-light-gray);
    }
    
    .checklist-options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 0.75rem;
        margin-bottom: 1rem;
    }
    
    .checklist-option {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        border: 2px solid var(--jd-light-gray);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
        background: var(--jd-white);
        position: relative;
        overflow: hidden;
        font-size: 0.9rem;
    }
    
    .checklist-option::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        transition: left 0.5s ease;
    }
    
    .checklist-option:hover::before {
        left: 100%;
    }
    
    .checklist-option:hover {
        transform: translateY(-1px);
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    
    .checklist-option.selected {
        border-color: var(--jd-black);
        background: var(--jd-black);
        color: var(--jd-white);
        box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    }
    
    .checklist-option.aceptable.selected {
        border-color: var(--jd-black);
        background: var(--jd-black);
    }
    
    .checklist-option.rechazado.selected {
        border-color: #dc3545;
        background: #dc3545;
    }
    
    .checklist-option.no-aplica.selected {
        border-color: #6c757d;
        background: #6c757d;
    }
    
    .checklist-option input[type="radio"] {
        display: none;
    }
    
    .checklist-option i {
        font-size: 1.2rem;
    }
    
    .notas-container {
        background: var(--jd-light-gray);
        border-radius: 8px;
        padding: 1rem;
        margin-top: 0.75rem;
    }
    
    .notas-label {
        font-weight: 600;
        color: var(--jd-black);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        font-size: 0.95rem;
    }
    
    .notas-textarea {
        width: 100%;
        min-height: 80px;
        padding: 0.75rem;
        border: 2px solid var(--jd-light-gray);
        border-radius: 6px;
        font-size: 0.9rem;
        resize: vertical;
        transition: all 0.3s ease;
        background: var(--jd-white);
        font-family: inherit;
    }
    
    .notas-textarea:focus {
        outline: none;
        border-color: var(--jd-black);
        box-shadow: 0 0 0 0.2rem rgba(0,0,0,0.1);
    }
    
    .navigation-buttons {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 2rem;
        padding: 2rem;
        background: var(--jd-white);
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    }
    
    .btn-nav {
        padding: 1rem 2rem;
        border-radius: 25px;
        font-weight: 700;
        font-size: 1.1rem;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .btn-prev {
        background: linear-gradient(135deg, var(--jd-gray) 0%, #34495e 100%);
        color: var(--jd-white);
    }
    
    .btn-next {
        background: linear-gradient(135deg, var(--jd-black) 0%, var(--jd-black-dark) 100%);
        color: var(--jd-white);
    }
    
    .btn-save {
        background: linear-gradient(135deg, var(--jd-yellow) 0%, var(--jd-yellow-dark) 100%);
        color: var(--jd-black);
        font-weight: 700;
    }
    
    .btn-nav:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .btn-nav:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }
    
    .estado-badge {
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        font-weight: 700;
        font-size: 1rem;
        position: relative;
        overflow: hidden;
    }
    
    .estado-borrador {
        background: linear-gradient(135deg, var(--jd-orange) 0%, #e67e22 100%);
        color: var(--jd-white);
    }
    
    .estado-completado {
        background: linear-gradient(135deg, var(--jd-black) 0%, var(--jd-black-dark) 100%);
        color: var(--jd-white);
    }
    
    .estado-enviado {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: var(--jd-white);
    }
    
    .save-indicator {
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--jd-black);
        color: var(--jd-white);
        padding: 1rem 2rem;
        border-radius: 25px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        z-index: 1000;
        opacity: 0;
        transform: translateY(-20px);
        transition: all 0.3s ease;
        border: 2px solid var(--jd-yellow);
        font-weight: 600;
    }
    
    .save-indicator.show {
        opacity: 1;
        transform: translateY(0);
    }
    
    .construction-theme {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        min-height: 100vh;
        padding: 20px 0;
    }
    
    .save-all-section {
        background: var(--jd-white);
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        padding: 2rem;
        margin-bottom: 2rem;
        border-left: 5px solid var(--jd-yellow);
    }
    
    .save-all-section h3 {
        color: var(--jd-black);
        margin-bottom: 1.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--jd-light-gray);
        display: flex;
        align-items: center;
        font-size: 1.3rem;
    }
</style>

<div class="construction-theme">
    <div class="container-fluid mt-4">
        <!-- Header -->
        <div class="checklist-header">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <div class="jd-logo">JD</div>
                    <div>
                        <h1><i class="fas fa-shield-alt me-3"></i>John Deere Construction - Checklist de Inspección</h1>
                        <p class="mb-0"><i class="fas fa-tag me-2"></i>ID: #{{ checklist.id }} - {{ checklist.equipo.numero_serie }}</p>
                    </div>
                </div>
                <div class="text-end">
                    <span class="estado-badge 
                        {% if checklist.estado == 'BORRADOR' %}estado-borrador
                        {% elif checklist.estado == 'COMPLETADO' %}estado-completado
                        {% elif checklist.estado == 'ENVIADO' %}estado-enviado
                        {% endif %}">
                        <i class="fas fa-circle me-2"></i>{{ checklist.get_estado_display }}
                    </span>
                </div>
            </div>
        </div>

        <!-- Información General -->
        <div class="info-card">
            <h3><i class="fas fa-info-circle me-2"></i>Información del Equipo</h3>
            <div class="row">
                <div class="col-md-3">
                    <strong><i class="fas fa-tools me-2"></i>Servicio:</strong> #{{ checklist.servicio.id }}
                </div>
                <div class="col-md-3">
                    <strong><i class="fas fa-building me-2"></i>Cliente:</strong> {{ checklist.servicio.preorden.cliente.razon_social }}
                </div>
                <div class="col-md-3">
                    <strong><i class="fas fa-cog me-2"></i>Equipo:</strong> {{ checklist.equipo.numero_serie }}
                </div>
                <div class="col-md-3">
                    <strong><i class="fas fa-calendar me-2"></i>Fecha:</strong> {{ checklist.fecha_inspeccion|date:"d/m/Y" }}
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-3">
                    <strong><i class="fas fa-tachometer-alt me-2"></i>Horómetro:</strong> {{ checklist.horometro|default:"N/A" }}
                </div>
                <div class="col-md-3">
                    <strong><i class="fas fa-user me-2"></i>Creado por:</strong> {{ checklist.creado_por.get_nombre_completo }}
                </div>
                <div class="col-md-3">
                    <strong><i class="fas fa-list me-2"></i>Total elementos:</strong> {{ checklist.total_elementos }}
                </div>
                <div class="col-md-3">
                    <strong><i class="fas fa-percentage me-2"></i>% Aceptable:</strong> {{ checklist.porcentaje_aceptable|floatformat:1 }}%
                </div>
            </div>
        </div>

        <!-- Indicador de Progreso por Etapas -->
        <div class="progress-steps">
            <h3><i class="fas fa-route me-2"></i>Progreso por Etapas</h3>
            <div class="step-indicator">
                <div class="step active" data-step="1">
                    <div class="step-circle">1</div>
                    <div class="step-label">Chasis y Estructura</div>
                </div>
                <div class="step" data-step="2">
                    <div class="step-circle">2</div>
                    <div class="step-label">Llantas y Carrilería</div>
                </div>
                <div class="step" data-step="3">
                    <div class="step-circle">3</div>
                    <div class="step-label">Cabina</div>
                </div>
                <div class="step" data-step="4">
                    <div class="step-circle">4</div>
                    <div class="step-label">Motor</div>
                </div>
                <div class="step" data-step="5">
                    <div class="step-circle">5</div>
                    <div class="step-label">Transmission</div>
                </div>
                <div class="step" data-step="6">
                    <div class="step-circle">6</div>
                    <div class="step-label">Sistema Hidráulico</div>
                </div>
                <div class="step" data-step="7">
                    <div class="step-circle">7</div>
                    <div class="step-label">Sistema Eléctrico</div>
                </div>
                <div class="step" data-step="8">
                    <div class="step-circle">8</div>
                    <div class="step-label">Sistema de Frenos</div>
                </div>
                <div class="step" data-step="9">
                    <div class="step-circle">9</div>
                    <div class="step-label">Sistema de Refrigeración</div>
                </div>
            </div>
        </div>

        <!-- Etapas del Checklist -->
        {% for seccion_nombre, elementos in elementos_por_seccion.items %}
        <div class="step-section {% if forloop.first %}active{% endif %}" data-step="{{ forloop.counter }}">
            <div class="section-header">
                <h2>
                    <i class="fas fa-cogs me-3"></i>{{ seccion_nombre }}
                    <span class="badge bg-warning text-dark">
                        <i class="fas fa-clock me-1"></i>Etapa {{ forloop.counter }} de 9
                    </span>
                </h2>
            </div>

            <div class="section-progress">
                <h5><i class="fas fa-chart-bar me-2"></i>Progreso de esta Etapa</h5>
                <div class="progress mb-3">
                    <div class="progress-bar bg-success" role="progressbar" style="width: 0%" id="progress-{{ forloop.counter }}">
                        0%
                    </div>
                </div>
                <div class="row text-center">
                    <div class="col-4">
                        <div class="text-success">
                            <strong id="aceptables-{{ forloop.counter }}">0</strong><br>
                            <small><i class="fas fa-check me-1"></i>Aceptable</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="text-danger">
                            <strong id="rechazados-{{ forloop.counter }}">0</strong><br>
                            <small><i class="fas fa-times me-1"></i>Rechazado</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="text-muted">
                            <strong id="no-aplican-{{ forloop.counter }}">0</strong><br>
                            <small><i class="fas fa-minus me-1"></i>No Aplica</small>
                        </div>
                    </div>
                </div>
            </div>

            {% for elemento in elementos %}
            <div class="elemento-item" data-elemento-id="{{ elemento.id }}" data-seccion="{{ forloop.parentloop.counter }}">
                <div class="elemento-nombre">{{ elemento.nombre_elemento }}</div>
                
                <div class="checklist-options">
                    <label class="checklist-option aceptable {% if elemento.respuesta == 'A' %}selected{% endif %}">
                        <input type="radio" name="respuesta_{{ elemento.id }}" value="A" 
                               {% if elemento.respuesta == 'A' %}checked{% endif %}
                               onchange="actualizarRespuesta({{ elemento.id }}, 'A')">
                        <i class="fas fa-check"></i>
                        <span>Aceptable</span>
                    </label>
                    
                    <label class="checklist-option rechazado {% if elemento.respuesta == 'R' %}selected{% endif %}">
                        <input type="radio" name="respuesta_{{ elemento.id }}" value="R"
                               {% if elemento.respuesta == 'R' %}checked{% endif %}
                               onchange="actualizarRespuesta({{ elemento.id }}, 'R')">
                        <i class="fas fa-times"></i>
                        <span>Rechazado</span>
                    </label>
                    
                    <label class="checklist-option no-aplica {% if elemento.respuesta == 'N/A' %}selected{% endif %}">
                        <input type="radio" name="respuesta_{{ elemento.id }}" value="N/A"
                               {% if elemento.respuesta == 'N/A' %}checked{% endif %}
                               onchange="actualizarRespuesta({{ elemento.id }}, 'N/A')">
                        <i class="fas fa-minus"></i>
                        <span>No Aplica</span>
                    </label>
                </div>
                
                <div class="notas-container">
                    <label class="notas-label">
                        <i class="fas fa-sticky-note me-2"></i>Notas sobre este elemento:
                    </label>
                    <textarea class="notas-textarea" 
                              placeholder="Describe cualquier observación, problema o detalle importante sobre este elemento..."
                              onchange="actualizarNotas({{ elemento.id }}, this.value)">{{ elemento.notas }}</textarea>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endfor %}

        <!-- Navegación -->
        <div class="navigation-buttons">
            <button type="button" class="btn-nav btn-prev" onclick="anteriorEtapa()" id="btn-prev" disabled>
                <i class="fas fa-arrow-left"></i>Etapa Anterior
            </button>
            
            <div class="d-flex gap-2">
                <a href="{% url 'gestionDeTaller:detalle_servicio' checklist.servicio.id %}" class="btn-nav btn-prev">
                    <i class="fas fa-arrow-left me-2"></i>Volver al Servicio
                </a>
                <button type="button" class="btn-nav btn-save" onclick="guardarTodo()">
                    <i class="fas fa-save me-2"></i>Guardar Todo
                </button>
            </div>
            
            <button type="button" class="btn-nav btn-next" onclick="siguienteEtapa()" id="btn-next">
                Siguiente Etapa<i class="fas fa-arrow-right"></i>
            </button>
        </div>

        <!-- Sección de Guardar Todo -->
        <div class="save-all-section">
            <h3><i class="fas fa-save me-2"></i>Configuración Final del Checklist</h3>
            <div class="row">
                <div class="col-md-4">
                    <label for="estado" class="form-label"><i class="fas fa-flag me-2"></i>Estado:</label>
                    <select class="form-control" id="estado" name="estado">
                        <option value="BORRADOR" {% if checklist.estado == 'BORRADOR' %}selected{% endif %}>Borrador</option>
                        <option value="COMPLETADO" {% if checklist.estado == 'COMPLETADO' %}selected{% endif %}>Completado</option>
                        <option value="ENVIADO" {% if checklist.estado == 'ENVIADO' %}selected{% endif %}>Enviado</option>
                    </select>
                </div>
                <div class="col-md-8">
                    <label for="notas_generales" class="form-label"><i class="fas fa-comment me-2"></i>Notas Generales:</label>
                    <textarea class="form-control" id="notas_generales" name="notas_generales" rows="3" placeholder="Agregar notas generales sobre toda la inspección...">{{ checklist.notas_generales }}</textarea>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Indicador de guardado -->
<div class="save-indicator" id="saveIndicator">
    <i class="fas fa-check me-2"></i>Guardado automáticamente
</div>

<script>
    // Variables para almacenar cambios pendientes
    let cambiosPendientes = {};
    let notasPendientes = {};
    let etapaActual = 1;
    const totalEtapas = 9;
    
    function actualizarEtapa(nuevaEtapa) {
        // Ocultar etapa actual
        document.querySelector(`.step-section[data-step="${etapaActual}"]`).classList.remove('active');
        document.querySelector(`.step[data-step="${etapaActual}"]`).classList.remove('active');
        
        // Mostrar nueva etapa
        document.querySelector(`.step-section[data-step="${nuevaEtapa}"]`).classList.add('active');
        document.querySelector(`.step[data-step="${nuevaEtapa}"]`).classList.add('active');
        
        etapaActual = nuevaEtapa;
        
        // Actualizar botones de navegación
        document.getElementById('btn-prev').disabled = etapaActual === 1;
        document.getElementById('btn-next').disabled = etapaActual === totalEtapas;
        
        // Actualizar progreso de la etapa
        actualizarProgresoEtapa(etapaActual);
    }
    
    function anteriorEtapa() {
        if (etapaActual > 1) {
            actualizarEtapa(etapaActual - 1);
        }
    }
    
    function siguienteEtapa() {
        if (etapaActual < totalEtapas) {
            actualizarEtapa(etapaActual + 1);
        }
    }
    
    function actualizarProgresoEtapa(etapa) {
        const elementos = document.querySelectorAll(`.step-section[data-step="${etapa}"] .elemento-item`);
        let completados = 0;
        let aceptables = 0;
        let rechazados = 0;
        let noAplican = 0;
        
        elementos.forEach(elemento => {
            const selectedOption = elemento.querySelector('.checklist-option.selected');
            if (selectedOption) {
                completados++;
                const respuesta = selectedOption.querySelector('input').value;
                if (respuesta === 'A') aceptables++;
                else if (respuesta === 'R') rechazados++;
                else if (respuesta === 'N/A') noAplican++;
            }
        });
        
        const porcentaje = elementos.length > 0 ? (completados / elementos.length) * 100 : 0;
        
        // Actualizar barra de progreso
        const progressBar = document.getElementById(`progress-${etapa}`);
        if (progressBar) {
            progressBar.style.width = `${porcentaje}%`;
            progressBar.textContent = `${Math.round(porcentaje)}%`;
        }
        
        // Actualizar contadores
        const aceptablesEl = document.getElementById(`aceptables-${etapa}`);
        const rechazadosEl = document.getElementById(`rechazados-${etapa}`);
        const noAplicanEl = document.getElementById(`no-aplican-${etapa}`);
        
        if (aceptablesEl) aceptablesEl.textContent = aceptables;
        if (rechazadosEl) rechazadosEl.textContent = rechazados;
        if (noAplicanEl) noAplicanEl.textContent = noAplican;
        
        // Marcar etapa como completada si todos los elementos están completados
        const stepElement = document.querySelector(`.step[data-step="${etapa}"]`);
        if (completados === elementos.length && elementos.length > 0) {
            stepElement.classList.add('completed');
        } else {
            stepElement.classList.remove('completed');
        }
    }
    
    function actualizarRespuesta(elementoId, respuesta) {
        // Solo actualizar visualmente, no guardar automáticamente
        const elementoItem = document.querySelector(`[data-elemento-id="${elementoId}"]`);
        elementoItem.querySelectorAll('.checklist-option').forEach(option => {
            option.classList.remove('selected');
        });
        
        const selectedOption = elementoItem.querySelector(`.checklist-option input[value="${respuesta}"]`).parentElement;
        selectedOption.classList.add('selected');
        
        // Guardar cambio pendiente
        cambiosPendientes[elementoId] = respuesta;
        
        // Actualizar progreso de la etapa actual
        actualizarProgresoEtapa(etapaActual);
        
        // Mostrar indicador de cambio pendiente
        mostrarIndicadorCambio();
    }
    
    function actualizarNotas(elementoId, notas) {
        // Guardar nota pendiente
        notasPendientes[elementoId] = notas;
        
        // Mostrar indicador de cambio pendiente
        mostrarIndicadorCambio();
    }
    
    function mostrarIndicadorCambio() {
        const indicator = document.getElementById('saveIndicator');
        indicator.innerHTML = '<i class="fas fa-clock me-2"></i>Cambios pendientes - Guardar para aplicar';
        indicator.style.background = 'var(--jd-orange)';
        indicator.classList.add('show');
        
        setTimeout(() => {
            indicator.classList.remove('show');
        }, 3000);
    }
    
    function mostrarIndicadorGuardado() {
        const indicator = document.getElementById('saveIndicator');
        indicator.innerHTML = '<i class="fas fa-check me-2"></i>¡Guardado exitosamente!';
        indicator.style.background = 'var(--jd-black)';
        indicator.classList.add('show');
        
        setTimeout(() => {
            indicator.classList.remove('show');
        }, 2000);
    }
    
    function guardarTodo() {
        // Crear FormData con todos los cambios pendientes
        const formData = new FormData();
        
        // Agregar estado y notas generales
        const estado = document.getElementById('estado').value;
        const notasGenerales = document.getElementById('notas_generales').value;
        formData.append('estado', estado);
        formData.append('notas_generales', notasGenerales);
        
        // Agregar cambios de elementos
        for (const [elementoId, respuesta] of Object.entries(cambiosPendientes)) {
            formData.append(`elemento_${elementoId}_respuesta`, respuesta);
            formData.append(`elemento_${elementoId}_notas`, notasPendientes[elementoId] || '');
        }
        
        // Enviar todos los cambios
        fetch(`/gestion_de_taller/checklist-inspeccion/${checklistId}/guardar-todo/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Limpiar cambios pendientes
                cambiosPendientes = {};
                notasPendientes = {};
                
                mostrarIndicadorGuardado();
                
                // Recargar página después de un delay
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                alert('Error al guardar: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al guardar el checklist');
        });
    }
    
    // Inicializar al cargar la página
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar progreso de la primera etapa
        actualizarProgresoEtapa(1);
        
        // Configurar navegación por teclado
        document.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowLeft' && etapaActual > 1) {
                anteriorEtapa();
            } else if (e.key === 'ArrowRight' && etapaActual < totalEtapas) {
                siguienteEtapa();
            }
        });
    });
</script>

<script>
    // Variable global para el ID del checklist
    const checklistId = {{ checklist.id }};
</script>
{% endblock %} 