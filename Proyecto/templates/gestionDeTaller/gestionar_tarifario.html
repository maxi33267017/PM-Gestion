{% extends 'base.html' %}
{% load static %}

{% block title %}Gestionar Tarifario{% endblock %}

{% block extra_css %}
<style>
    .tarifario-container {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
    }
    
    .form-section {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 25px;
        margin-bottom: 25px;
    }
    
    .form-section h4 {
        color: #2c3e50;
        margin-bottom: 20px;
        border-bottom: 2px solid #3498db;
        padding-bottom: 10px;
    }
    
    .btn-action {
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .table-container {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .table th {
        background: #34495e;
        color: white;
        border: none;
        font-weight: 600;
    }
    
    .table td {
        vertical-align: middle;
    }
    
    .badge-categoria {
        font-size: 0.8rem;
        padding: 5px 10px;
        border-radius: 15px;
    }
    
    .modal-content {
        border-radius: 15px;
        border: none;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }
    
    .modal-header {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
        border-radius: 15px 15px 0 0;
        border: none;
    }
    
    .alert {
        border-radius: 10px;
        border: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">
                    <i class="fas fa-cog me-2"></i>
                    Gestionar Tarifario
                </h2>
                <a href="{% url 'gestionDeTaller:dashboard_gerente' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-1"></i>
                    Volver al Dashboard
                </a>
            </div>
            
            <!-- Alertas -->
            <div id="alert-container"></div>
            
            <!-- Sección: Crear Tarifario -->
            <div class="tarifario-container">
                <div class="form-section">
                    <h4><i class="fas fa-dollar-sign me-2"></i>Crear Tarifario</h4>
                    <form id="form-tarifario">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="fecha_tarifario" class="form-label">Fecha</label>
                                    <input type="date" class="form-control" id="fecha_tarifario" name="fecha" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="tipo_equipo_tarifario" class="form-label">Tipo de Equipo</label>
                                    <select class="form-control" id="tipo_equipo_tarifario" name="tipo_equipo_id" required>
                                        <option value="">Seleccionar tipo...</option>
                                        {% for tipo in tipos_equipo %}
                                        <option value="{{ tipo.id }}">{{ tipo.nombre }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="nombre_servicio" class="form-label">Nombre del Servicio</label>
                                    <input type="text" class="form-control" id="nombre_servicio" name="nombre_servicio" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="precio_usd" class="form-label">Precio (USD)</label>
                                    <input type="number" class="form-control" id="precio_usd" name="precio_usd" step="0.01" min="0" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="modelos_equipo" class="form-label">Modelos de Equipo</label>
                                    <select class="form-control" id="modelos_equipo" name="modelos_equipo_ids" multiple required>
                                        <option value="">Primero selecciona un tipo de equipo</option>
                                    </select>
                                    <small class="form-text text-muted">Mantén presionado Ctrl (Cmd en Mac) para seleccionar múltiples modelos</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="descripcion_tarifario" class="form-label">Descripción</label>
                                    <textarea class="form-control" id="descripcion_tarifario" name="descripcion" rows="1"></textarea>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-info btn-action">
                            <i class="fas fa-plus me-1"></i>
                            Crear Tarifario
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- Sección: Lista de Tarifarios -->
            <div class="tarifario-container">
                <div class="card-body">
                    <h4 class="mb-4"><i class="fas fa-list me-2"></i>Tarifarios Existentes</h4>
                    
                    <div class="table-container">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Servicio</th>
                                    <th>Modelos</th>
                                    <th>Precio (USD)</th>
                                    <th>Descripción</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for tarifario in tarifarios %}
                                <tr>
                                    <td>
                                        <span class="badge badge-categoria bg-info">{{ tarifario.fecha }}</span>
                                    </td>
                                    <td>{{ tarifario.nombre_servicio }}</td>
                                    <td>
                                        {% for relacion in tarifario.modelos_equipo.all %}
                                        <span class="badge bg-secondary me-1">{{ relacion.modelo_equipo.marca }} {{ relacion.modelo_equipo.nombre }}</span>
                                        {% endfor %}
                                    </td>
                                    <td>
                                        <span class="badge bg-success">${{ tarifario.precio_usd }}</span>
                                    </td>
                                    <td>{{ tarifario.descripcion|default:"-" }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-danger" onclick="eliminarTarifario({{ tarifario.id }})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted">
                                        <i class="fas fa-info-circle me-2"></i>
                                        No hay tarifarios creados
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Función para mostrar alertas
function showAlert(message, type = 'success') {
    const alertContainer = document.getElementById('alert-container');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    alertContainer.appendChild(alert);
    
    // Auto-remover después de 5 segundos
    setTimeout(() => {
        alert.remove();
    }, 5000);
}

// Cargar modelos cuando cambie el tipo de equipo
document.getElementById('tipo_equipo_tarifario').addEventListener('change', function() {
    const tipoEquipoId = this.value;
    const modelosSelect = document.getElementById('modelos_equipo');
    
    // Limpiar opciones actuales
    modelosSelect.innerHTML = '<option value="">Cargando modelos...</option>';
    
    if (tipoEquipoId) {
        // Obtener modelos del tipo seleccionado
        const modelos = {{ modelos_json|safe }};
        const modelosFiltrados = modelos.filter(modelo => modelo.tipo_equipo_id == tipoEquipoId);
        
        // Limpiar y agregar opciones
        modelosSelect.innerHTML = '<option value="">Seleccionar modelos...</option>';
        
        modelosFiltrados.forEach(modelo => {
            const option = document.createElement('option');
            option.value = modelo.id;
            option.textContent = `${modelo.marca} ${modelo.nombre}`;
            modelosSelect.appendChild(option);
        });
    } else {
        modelosSelect.innerHTML = '<option value="">Primero selecciona un tipo de equipo</option>';
    }
});

// Crear Tarifario
document.getElementById('form-tarifario').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch('{% url "gestionDeTaller:crear_tarifario" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            this.reset();
            // Recargar la página para actualizar las listas
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert(data.message, 'danger');
        }
    })
    .catch(error => {
        showAlert('Error al crear tarifario', 'danger');
    });
});

// Eliminar Tarifario
function eliminarTarifario(tarifarioId) {
    if (!confirm('¿Estás seguro de que quieres eliminar este tarifario?')) {
        return;
    }
    
    const formData = new FormData();
    formData.append('tarifario_id', tarifarioId);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch('{% url "gestionDeTaller:eliminar_tarifario" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            // Recargar la página para actualizar las listas
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert(data.message, 'danger');
        }
    })
    .catch(error => {
        showAlert('Error al eliminar tarifario', 'danger');
    });
}
</script>
{% endblock %} 