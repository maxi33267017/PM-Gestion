{% extends 'base.html' %}
{% load static %}

{% block title %}Crear Nueva Venta - Venta Maquinarias{% endblock %}

{% block extra_css %}
<link href="{% static 'bootstrap-5.3.2-dist/css/bootstrap.min.css' %}" rel="stylesheet">
<link href="{% static 'DataTables/DataTables-1.13.8/css/dataTables.bootstrap5.min.css' %}" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<style>
    .form-container {
        background: white;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0,0,0,0.1);
        padding: 30px;
        margin: 20px 0;
    }
    .form-section {
        border-left: 4px solid #007bff;
        padding-left: 20px;
        margin-bottom: 30px;
    }
    .form-section h5 {
        color: #007bff;
        margin-bottom: 15px;
    }
    .required-field::after {
        content: " *";
        color: red;
    }
    .certificado-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
    }
    .certificado-checkbox {
        margin-bottom: 10px;
    }
    .certificado-select {
        margin-left: 20px;
    }
    .equipo-info {
        background: #e3f2fd;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-cart-plus text-primary"></i> Crear Nueva Venta</h2>
                <a href="{% url 'ventaMaquinarias:lista_ventas' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Volver a Ventas
                </a>
            </div>

            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}

            <div class="form-container">
                <form method="post" id="formCrearVenta">
                    {% csrf_token %}
                    
                    <!-- Selección de Equipo -->
                    <div class="form-section">
                        <h5><i class="fas fa-tractor"></i> Selección de Equipo</h5>
                        <div class="mb-3">
                            <label for="equipo_stock" class="form-label required-field">Equipo a Vender</label>
                            <select class="form-select" id="equipo_stock" name="equipo_stock" required>
                                <option value="">Seleccionar equipo disponible...</option>
                                {% for equipo in equipos_disponibles %}
                                    <option value="{{ equipo.id }}" 
                                            data-modelo="{{ equipo.modelo.nombre }}"
                                            data-tipo="{{ equipo.tipo_equipo.nombre }}"
                                            data-serie="{{ equipo.numero_serie }}"
                                            data-año="{{ equipo.año_fabricacion }}">
                                        {{ equipo.numero_serie }} - {{ equipo.modelo.nombre }} ({{ equipo.tipo_equipo.nombre }})
                                    </option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Solo se muestran equipos disponibles en stock</div>
                        </div>
                        
                        <!-- Información del equipo seleccionado -->
                        <div id="equipoInfo" class="equipo-info" style="display: none;">
                            <h6><i class="fas fa-info-circle"></i> Información del Equipo</h6>
                            <div class="row">
                                <div class="col-md-3">
                                    <strong>Número de Serie:</strong><br>
                                    <span id="infoSerie"></span>
                                </div>
                                <div class="col-md-3">
                                    <strong>Modelo:</strong><br>
                                    <span id="infoModelo"></span>
                                </div>
                                <div class="col-md-3">
                                    <strong>Tipo:</strong><br>
                                    <span id="infoTipo"></span>
                                </div>
                                <div class="col-md-3">
                                    <strong>Año:</strong><br>
                                    <span id="infoAño"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Información de la Venta -->
                    <div class="form-section">
                        <h5><i class="fas fa-file-invoice-dollar"></i> Información de la Venta</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="cliente" class="form-label required-field">Cliente</label>
                                <select class="form-select" id="cliente" name="cliente" required>
                                    <option value="">Seleccionar cliente...</option>
                                    {% for cliente in clientes %}
                                        <option value="{{ cliente.id }}">{{ cliente.razon_social }} - {{ cliente.cuit }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="fecha_venta" class="form-label required-field">Fecha de Venta</label>
                                <input type="date" class="form-control" id="fecha_venta" name="fecha_venta" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="precio_venta" class="form-label required-field">Precio de Venta</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="precio_venta" name="precio_venta" 
                                           step="0.01" min="0" required>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="numero_factura" class="form-label">Número de Factura</label>
                                <input type="text" class="form-control" id="numero_factura" name="numero_factura" 
                                       placeholder="Opcional">
                            </div>
                        </div>
                    </div>

                    <!-- Certificados -->
                    <div class="form-section">
                        <h5><i class="fas fa-certificate"></i> Certificados Asociados a la Venta</h5>
                        <p class="text-muted">Seleccione los certificados reales que se entregan con la venta. Se descontará 1 unidad de cada certificado seleccionado.</p>
                        <div class="mb-3">
                            <label for="certificados" class="form-label">Certificados</label>
                            <select class="form-select" id="certificados" name="certificados" multiple>
                                {% for cert in certificados %}
                                    <option value="{{ cert.id }}">{{ cert.nombre }} (Stock: {{ cert.stock_disponible }})</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Puede seleccionar varios certificados manteniendo presionada la tecla Ctrl (Windows) o Cmd (Mac).</div>
                        </div>
                    </div>

                    <!-- Observaciones -->
                    <div class="form-section">
                        <h5><i class="fas fa-comment"></i> Observaciones</h5>
                        <div class="mb-3">
                            <label for="observaciones" class="form-label">Observaciones de la Venta</label>
                            <textarea class="form-control" id="observaciones" name="observaciones" rows="3" 
                                      placeholder="Información adicional sobre la venta..."></textarea>
                        </div>
                    </div>

                    <!-- Botones de Acción -->
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'ventaMaquinarias:lista_ventas' %}" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Crear Venta
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'DataTables/jQuery-3.7.0/jquery-3.7.0.min.js' %}"></script>
<script src="{% static 'bootstrap-5.3.2-dist/js/bootstrap.bundle.min.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar Select2 para el select de cliente
    $('#cliente').select2({
        theme: 'bootstrap-5',
        placeholder: 'Seleccionar cliente...',
        allowClear: true,
        width: '100%',
        language: 'es',
        minimumInputLength: 1,
        templateResult: function(data) {
            if (data.loading) return data.text;
            if (data.id === '') return data.text;
            return $('<span>' + data.text + '</span>');
        }
    });
    
    // Establecer fecha actual como valor por defecto
    const fechaActual = new Date().toISOString().split('T')[0];
    document.getElementById('fecha_venta').value = fechaActual;
    
    // Mostrar información del equipo seleccionado
    const equipoSelect = document.getElementById('equipo_stock');
    const equipoInfo = document.getElementById('equipoInfo');
    
    equipoSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (this.value) {
            document.getElementById('infoSerie').textContent = selectedOption.dataset.serie;
            document.getElementById('infoModelo').textContent = selectedOption.dataset.modelo;
            document.getElementById('infoTipo').textContent = selectedOption.dataset.tipo;
            document.getElementById('infoAño').textContent = selectedOption.dataset.año;
            equipoInfo.style.display = 'block';
        } else {
            equipoInfo.style.display = 'none';
        }
    });
    
    // Mostrar/ocultar selects de certificados según checkboxes
    const checkboxes = ['check_garantia', 'check_garantia_extendida', 'check_svap'];
    const selects = ['select_garantia', 'select_garantia_extendida', 'select_svap'];
    
    checkboxes.forEach((checkboxId, index) => {
        const checkbox = document.getElementById(checkboxId);
        const select = document.getElementById(selects[index]);
        
        checkbox.addEventListener('change', function() {
            select.style.display = this.checked ? 'block' : 'none';
            if (!this.checked) {
                // Limpiar el select cuando se desmarca el checkbox
                select.querySelector('select').value = '';
            }
        });
    });
    
    // Validación del formulario
    const form = document.getElementById('formCrearVenta');
    
    form.addEventListener('submit', function(e) {
        const equipoStock = document.getElementById('equipo_stock').value;
        const cliente = document.getElementById('cliente').value;
        const fechaVenta = document.getElementById('fecha_venta').value;
        const precioVenta = document.getElementById('precio_venta').value;
        
        // Validar campos requeridos
        if (!equipoStock || !cliente || !fechaVenta || !precioVenta) {
            e.preventDefault();
            alert('Por favor complete todos los campos requeridos (*)');
            return false;
        }
        
        // Validar precio de venta
        if (parseFloat(precioVenta) <= 0) {
            e.preventDefault();
            alert('El precio de venta debe ser mayor a 0');
            return false;
        }
        
        // Validar fecha de venta
        const fechaVentaDate = new Date(fechaVenta);
        const fechaActual = new Date();
        if (fechaVentaDate > fechaActual) {
            e.preventDefault();
            alert('La fecha de venta no puede ser futura');
            return false;
        }
        
        // Validar que si se marca un checkbox, se seleccione el certificado correspondiente
        const certificadosRequeridos = [
            {checkbox: 'check_garantia', select: 'certificado_garantia'},
            {checkbox: 'check_garantia_extendida', select: 'certificado_garantia_extendida'},
            {checkbox: 'check_svap', select: 'certificado_svap'}
        ];
        
        for (const cert of certificadosRequeridos) {
            const checkbox = document.getElementById(cert.checkbox);
            const select = document.getElementById(cert.select);
            
            if (checkbox.checked && !select.value) {
                e.preventDefault();
                alert('Si marca un certificado, debe seleccionar uno específico');
                return false;
            }
        }
    });
});
</script>
{% endblock %} 