{% extends 'base.html' %}
{% block title %} | Gestión de Códigos de Alerta{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-5 mb-2">
                        <i class="bi bi-database me-2"></i>Gestión de Códigos de Alerta
                    </h1>
                    <p class="lead text-muted">Administra la base de datos de códigos de alerta para equipos</p>
                </div>
                <div>
                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalNuevoCodigo">
                        <i class="bi bi-plus-circle me-2"></i>Nuevo Código
                    </button>
                    <a href="{% url 'centroSoluciones:centro_soluciones_dashboard' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-2"></i>Volver
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-funnel me-2"></i>Filtros
                    </h5>
                </div>
                <div class="card-body">
                    <form method="GET" class="row g-3">
                        <div class="col-md-3">
                            <label for="search" class="form-label">Buscar</label>
                            <input type="text" class="form-control" id="search" name="search" 
                                   value="{{ search_filtro }}" placeholder="Código, descripción o modelo...">
                        </div>
                        <div class="col-md-2">
                            <label for="clasificacion" class="form-label">Clasificación</label>
                            <select class="form-select" id="clasificacion" name="clasificacion">
                                <option value="">Todas</option>
                                {% for valor, nombre in clasificaciones %}
                                <option value="{{ valor }}" {% if clasificacion_filtro == valor %}selected{% endif %}>
                                    {{ nombre }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="modelo" class="form-label">Modelo de Equipo</label>
                            <select class="form-select" id="modelo" name="modelo">
                                <option value="">Todos</option>
                                {% for modelo in modelos_unicos %}
                                <option value="{{ modelo }}" {% if modelo_filtro == modelo %}selected{% endif %}>
                                    {{ modelo }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="activo" class="form-label">Estado</label>
                            <select class="form-select" id="activo" name="activo">
                                <option value="">Todos</option>
                                <option value="true" {% if activo_filtro == 'true' %}selected{% endif %}>Activo</option>
                                <option value="false" {% if activo_filtro == 'false' %}selected{% endif %}>Inactivo</option>
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <div class="d-grid gap-2 w-100">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-search me-2"></i>Filtrar
                                </button>
                                <a href="{% url 'centroSoluciones:gestionar_codigos_alerta' %}" class="btn btn-outline-secondary">
                                    <i class="bi bi-x-circle me-2"></i>Limpiar
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de códigos -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-list-ul me-2"></i>Códigos de Alerta
                        <span class="badge bg-primary ms-2">{{ page_obj.paginator.count }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    {% if page_obj %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Código</th>
                                    <th>Modelo</th>
                                    <th>Descripción</th>
                                    <th>Clasificación</th>
                                    <th>Tiempo Est.</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for codigo in page_obj %}
                                <tr>
                                    <td>
                                        <strong>{{ codigo.codigo }}</strong>
                                    </td>
                                    <td>{{ codigo.modelo_equipo }}</td>
                                    <td>
                                        <div class="text-truncate" style="max-width: 300px;" title="{{ codigo.descripcion }}">
                                            {{ codigo.descripcion }}
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ codigo.get_prioridad_color }}">
                                            {{ codigo.get_clasificacion_display }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if codigo.tiempo_estimado_resolucion %}
                                            {{ codigo.tiempo_estimado_resolucion }}h
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if codigo.activo %}
                                            <span class="badge bg-success">Activo</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Inactivo</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-outline-info" 
                                                    data-bs-toggle="modal" data-bs-target="#modalDetalleCodigo{{ codigo.id }}">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <a href="/admin/centroSoluciones/codigoalerta/{{ codigo.id }}/change/" 
                                               class="btn btn-outline-warning" target="_blank">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                
                                <!-- Modal de detalle -->
                                <div class="modal fade" id="modalDetalleCodigo{{ codigo.id }}" tabindex="-1">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">
                                                    <i class="bi bi-info-circle me-2"></i>Detalle del Código {{ codigo.codigo }}
                                                </h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                            </div>
                                            <div class="modal-body">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <p><strong>Código:</strong> {{ codigo.codigo }}</p>
                                                        <p><strong>Modelo:</strong> {{ codigo.modelo_equipo }}</p>
                                                        <p><strong>Clasificación:</strong> 
                                                            <span class="badge bg-{{ codigo.get_prioridad_color }}">
                                                                {{ codigo.get_clasificacion_display }}
                                                            </span>
                                                        </p>
                                                        <p><strong>Estado:</strong> 
                                                            {% if codigo.activo %}
                                                                <span class="badge bg-success">Activo</span>
                                                            {% else %}
                                                                <span class="badge bg-secondary">Inactivo</span>
                                                            {% endif %}
                                                        </p>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <p><strong>Tiempo Estimado:</strong> 
                                                            {% if codigo.tiempo_estimado_resolucion %}
                                                                {{ codigo.tiempo_estimado_resolucion }} horas
                                                            {% else %}
                                                                No especificado
                                                            {% endif %}
                                                        </p>
                                                        <p><strong>Creado por:</strong> 
                                                            {% if codigo.creado_por %}
                                                                {{ codigo.creado_por.get_nombre_completo }}
                                                            {% else %}
                                                                Sistema
                                                            {% endif %}
                                                        </p>
                                                        <p><strong>Fecha creación:</strong> {{ codigo.fecha_creacion|date:"d/m/Y H:i" }}</p>
                                                    </div>
                                                </div>
                                                <hr>
                                                <div class="row">
                                                    <div class="col-12">
                                                        <h6>Descripción:</h6>
                                                        <p>{{ codigo.descripcion }}</p>
                                                    </div>
                                                </div>
                                                {% if codigo.instrucciones_resolucion %}
                                                <div class="row">
                                                    <div class="col-12">
                                                        <h6>Instrucciones de Resolución:</h6>
                                                        <p>{{ codigo.instrucciones_resolucion }}</p>
                                                    </div>
                                                </div>
                                                {% endif %}
                                                {% if codigo.repuestos_comunes %}
                                                <div class="row">
                                                    <div class="col-12">
                                                        <h6>Repuestos Comunes:</h6>
                                                        <p>{{ codigo.repuestos_comunes }}</p>
                                                    </div>
                                                </div>
                                                {% endif %}
                                            </div>
                                            <div class="modal-footer">
                                                <a href="/admin/centroSoluciones/codigoalerta/{{ codigo.id }}/change/" 
                                                   class="btn btn-warning" target="_blank">
                                                    <i class="bi bi-pencil me-2"></i>Editar
                                                </a>
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Paginación -->
                    {% if page_obj.has_other_pages %}
                    <nav aria-label="Navegación de páginas">
                        <ul class="pagination justify-content-center">
                            {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page=1{% if search_filtro %}&search={{ search_filtro }}{% endif %}{% if clasificacion_filtro %}&clasificacion={{ clasificacion_filtro }}{% endif %}{% if modelo_filtro %}&modelo={{ modelo_filtro }}{% endif %}{% if activo_filtro %}&activo={{ activo_filtro }}{% endif %}">
                                        <i class="bi bi-chevron-double-left"></i>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search_filtro %}&search={{ search_filtro }}{% endif %}{% if clasificacion_filtro %}&clasificacion={{ clasificacion_filtro }}{% endif %}{% if modelo_filtro %}&modelo={{ modelo_filtro }}{% endif %}{% if activo_filtro %}&activo={{ activo_filtro }}{% endif %}">
                                        <i class="bi bi-chevron-left"></i>
                                    </a>
                                </li>
                            {% endif %}

                            {% for num in page_obj.paginator.page_range %}
                                {% if page_obj.number == num %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ num }}</span>
                                    </li>
                                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ num }}{% if search_filtro %}&search={{ search_filtro }}{% endif %}{% if clasificacion_filtro %}&clasificacion={{ clasificacion_filtro }}{% endif %}{% if modelo_filtro %}&modelo={{ modelo_filtro }}{% endif %}{% if activo_filtro %}&activo={{ activo_filtro }}{% endif %}">{{ num }}</a>
                                    </li>
                                {% endif %}
                            {% endfor %}

                            {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search_filtro %}&search={{ search_filtro }}{% endif %}{% if clasificacion_filtro %}&clasificacion={{ clasificacion_filtro }}{% endif %}{% if modelo_filtro %}&modelo={{ modelo_filtro }}{% endif %}{% if activo_filtro %}&activo={{ activo_filtro }}{% endif %}">
                                        <i class="bi bi-chevron-right"></i>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if search_filtro %}&search={{ search_filtro }}{% endif %}{% if clasificacion_filtro %}&clasificacion={{ clasificacion_filtro }}{% endif %}{% if modelo_filtro %}&modelo={{ modelo_filtro }}{% endif %}{% if activo_filtro %}&activo={{ activo_filtro }}{% endif %}">
                                        <i class="bi bi-chevron-double-right"></i>
                                    </a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-database-x display-1 text-muted"></i>
                        <h4 class="mt-3">No se encontraron códigos de alerta</h4>
                        <p class="text-muted">No hay códigos que coincidan con los filtros aplicados.</p>
                        <a href="{% url 'centroSoluciones:gestionar_codigos_alerta' %}" class="btn btn-primary">
                            <i class="bi bi-arrow-clockwise me-2"></i>Limpiar filtros
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nuevo Código -->
<div class="modal fade" id="modalNuevoCodigo" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle me-2"></i>Nuevo Código de Alerta
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="formNuevoCodigo">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="codigo" class="form-label">Código *</label>
                            <input type="text" class="form-control" id="codigo" name="codigo" required>
                        </div>
                        <div class="col-md-6">
                            <label for="modelo_equipo" class="form-label">Modelo de Equipo *</label>
                            <input type="text" class="form-control" id="modelo_equipo" name="modelo_equipo" required>
                        </div>
                        <div class="col-md-6">
                            <label for="clasificacion" class="form-label">Clasificación *</label>
                            <select class="form-select" id="clasificacion" name="clasificacion" required>
                                <option value="">Seleccionar...</option>
                                {% for valor, nombre in clasificaciones %}
                                <option value="{{ valor }}">{{ nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="tiempo_estimado_resolucion" class="form-label">Tiempo Estimado (horas)</label>
                            <input type="number" class="form-control" id="tiempo_estimado_resolucion" name="tiempo_estimado_resolucion" min="0">
                        </div>
                        <div class="col-12">
                            <label for="descripcion" class="form-label">Descripción *</label>
                            <textarea class="form-control" id="descripcion" name="descripcion" rows="3" required></textarea>
                        </div>
                        <div class="col-12">
                            <label for="instrucciones_resolucion" class="form-label">Instrucciones de Resolución</label>
                            <textarea class="form-control" id="instrucciones_resolucion" name="instrucciones_resolucion" rows="3"></textarea>
                        </div>
                        <div class="col-12">
                            <label for="repuestos_comunes" class="form-label">Repuestos Comunes</label>
                            <textarea class="form-control" id="repuestos_comunes" name="repuestos_comunes" rows="2"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-circle me-2"></i>Crear Código
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Manejar envío del formulario de nuevo código
    $('#formNuevoCodigo').on('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        $.ajax({
            url: '{% url "centroSoluciones:crear_codigo_alerta" %}',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    $('#modalNuevoCodigo').modal('hide');
                    // Mostrar mensaje de éxito
                    alert(response.message);
                    // Recargar la página para mostrar el nuevo código
                    location.reload();
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function(xhr) {
                console.error('Error al crear código:', xhr.responseText);
                alert('Error al crear el código. Por favor, intenta nuevamente.');
            }
        });
    });
});
</script>
{% endblock %} 