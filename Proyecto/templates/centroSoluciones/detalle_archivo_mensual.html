{% extends 'base.html' %}
{% load static %}

{% block title %}Detalle Archivo - {{ archivo.nombre_archivo }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2>
                        <i class="fas fa-file-excel me-2"></i>
                        Detalle del Archivo
                    </h2>
                    <p class="text-muted mb-0">{{ archivo.nombre_archivo }}</p>
                </div>
                <div>
                    <a href="{% url 'centroSoluciones:archivos_mensuales' %}" class="btn btn-secondary me-2">
                        <i class="fas fa-arrow-left me-1"></i>Volver
                    </a>
                    {% if archivo.estado == 'ERROR' %}
                        <a href="{% url 'centroSoluciones:reprocesar_archivo_mensual' archivo.id %}" 
                           class="btn btn-warning" onclick="return confirm('¿Está seguro de reprocesar este archivo?')">
                            <i class="fas fa-redo me-1"></i>Reprocesar
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Información del archivo -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>Información del Archivo
                    </h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tr>
                            <td><strong>Nombre:</strong></td>
                            <td>{{ archivo.nombre_archivo }}</td>
                        </tr>
                        <tr>
                            <td><strong>Tipo:</strong></td>
                            <td>
                                <span class="badge bg-info">
                                    {{ archivo.get_tipo_display }}
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Estado:</strong></td>
                            <td>
                                {% if archivo.estado == 'COMPLETADO' %}
                                    <span class="badge bg-success">
                                        <i class="fas fa-check me-1"></i>Completado
                                    </span>
                                {% elif archivo.estado == 'PROCESANDO' %}
                                    <span class="badge bg-warning">
                                        <i class="fas fa-cog fa-spin me-1"></i>Procesando
                                    </span>
                                {% elif archivo.estado == 'ERROR' %}
                                    <span class="badge bg-danger">
                                        <i class="fas fa-exclamation-triangle me-1"></i>Error
                                    </span>
                                {% else %}
                                    <span class="badge bg-secondary">
                                        <i class="fas fa-clock me-1"></i>Pendiente
                                    </span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Período:</strong></td>
                            <td>{{ archivo.periodo|default:"No especificado" }}</td>
                        </tr>
                        <tr>
                            <td><strong>Registros:</strong></td>
                            <td>{{ archivo.registros_procesados }} / {{ archivo.total_registros }}</td>
                        </tr>
                        <tr>
                            <td><strong>Cargado por:</strong></td>
                            <td>{{ archivo.cargado_por.get_full_name|default:archivo.cargado_por.username }}</td>
                        </tr>
                        <tr>
                            <td><strong>Fecha de carga:</strong></td>
                            <td>{{ archivo.fecha_carga|date:"d/m/Y H:i" }}</td>
                        </tr>
                        {% if archivo.fecha_procesamiento %}
                        <tr>
                            <td><strong>Procesado:</strong></td>
                            <td>{{ archivo.fecha_procesamiento|date:"d/m/Y H:i" }}</td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Estadísticas
                    </h5>
                </div>
                <div class="card-body">
                    {% if archivo.total_registros > 0 %}
                        <div class="mb-3">
                            <label class="form-label">Progreso de procesamiento:</label>
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" 
                                     style="width: {{ archivo.registros_procesados|floatformat:0|add:0|div:archivo.total_registros|mul:100 }}%">
                                    {{ archivo.registros_procesados|floatformat:0|add:0|div:archivo.total_registros|mul:100 }}%
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    {% if archivo.log_procesamiento %}
                        <div class="mb-3">
                            <label class="form-label">Log de procesamiento:</label>
                            <pre class="bg-light p-2 rounded small">{{ archivo.log_procesamiento }}</pre>
                        </div>
                    {% endif %}

                    {% if archivo.errores %}
                        <div class="mb-3">
                            <label class="form-label text-danger">Errores:</label>
                            <pre class="bg-danger text-white p-2 rounded small">{{ archivo.errores }}</pre>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Datos procesados -->
    {% if datos %}
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-database me-2"></i>
                            Datos Procesados ({{ datos.count }} registros)
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if archivo.tipo == 'UTILIZACION' %}
                            <!-- Tabla para datos de utilización -->
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Máquina</th>
                                            <th>Número de Serie</th>
                                            <th>Modelo</th>
                                            <th>Período</th>
                                            <th>Horas Motor</th>
                                            <th>Combustible (l)</th>
                                            <th>Consumo Promedio (l/h)</th>
                                            <th>Modo ECO (%)</th>
                                            <th>Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for dato in datos %}
                                        <tr>
                                            <td>
                                                <strong>{{ dato.maquina|truncatechars:30 }}</strong>
                                                {% if dato.equipo %}
                                                    <br><small class="text-success">Vinculado</small>
                                                {% else %}
                                                    <br><small class="text-warning">Sin vincular</small>
                                                {% endif %}
                                            </td>
                                            <td>{{ dato.numero_serie|truncatechars:15 }}</td>
                                            <td>{{ dato.modelo }}</td>
                                            <td>
                                                {% if dato.fecha_inicio and dato.fecha_fin %}
                                                    {{ dato.fecha_inicio|date:"d/m/Y" }} - {{ dato.fecha_fin|date:"d/m/Y" }}
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if dato.horas_trabajo_motor_periodo %}
                                                    {{ dato.horas_trabajo_motor_periodo|floatformat:1 }}
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if dato.combustible_consumido_periodo %}
                                                    {{ dato.combustible_consumido_periodo|floatformat:1 }}
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if dato.consumo_promedio_periodo %}
                                                    {{ dato.consumo_promedio_periodo|floatformat:2 }}
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if dato.modo_eco_activado_porcentaje %}
                                                    {{ dato.modo_eco_activado_porcentaje|floatformat:1 }}%
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if dato.estado_maquina %}
                                                    <span class="badge bg-success">{{ dato.estado_maquina }}</span>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <!-- Tabla para notificaciones -->
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>PIN Máquina</th>
                                            <th>Fecha</th>
                                            <th>Hora</th>
                                            <th>Severidad</th>
                                            <th>Categoría</th>
                                            <th>Descripción</th>
                                            <th>Incidencias</th>
                                            <th>Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for notif in datos %}
                                        <tr>
                                            <td>
                                                <strong>{{ notif.pin_maquina }}</strong>
                                                {% if notif.equipo %}
                                                    <br><small class="text-success">Vinculado</small>
                                                {% else %}
                                                    <br><small class="text-warning">Sin vincular</small>
                                                {% endif %}
                                            </td>
                                            <td>{{ notif.fecha|date:"d/m/Y" }}</td>
                                            <td>{{ notif.codigo_hora|time:"H:i" }}</td>
                                            <td>
                                                {% if notif.severidad == 'Info' %}
                                                    <span class="badge bg-info">{{ notif.severidad }}</span>
                                                {% elif notif.severidad == 'Mediana' %}
                                                    <span class="badge bg-warning">{{ notif.severidad }}</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">{{ notif.severidad }}</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ notif.categoria|truncatechars:20 }}</td>
                                            <td>{{ notif.descripcion|truncatechars:50 }}</td>
                                            <td>{{ notif.incidencias }}</td>
                                            <td>
                                                {% if notif.resuelta %}
                                                    <span class="badge bg-success">Resuelta</span>
                                                {% else %}
                                                    <span class="badge bg-warning">Pendiente</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-database fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No hay datos procesados</h5>
                        <p class="text-muted">
                            {% if archivo.estado == 'PENDIENTE' %}
                                El archivo está pendiente de procesamiento.
                            {% elif archivo.estado == 'PROCESANDO' %}
                                El archivo se está procesando actualmente.
                            {% elif archivo.estado == 'ERROR' %}
                                Ocurrió un error durante el procesamiento.
                            {% else %}
                                No se encontraron datos en este archivo.
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-refresh si el archivo está procesando
    {% if archivo.estado == 'PROCESANDO' %}
        setTimeout(function() {
            location.reload();
        }, 5000); // Recargar cada 5 segundos
    {% endif %}
});
</script>
{% endblock %}
