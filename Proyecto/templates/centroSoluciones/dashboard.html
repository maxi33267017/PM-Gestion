{% extends 'base.html' %}
{% block title %} | Centro de Soluciones Conectadas{% endblock %}

{% block content %}
<style>
    /* Estilos específicos para los modales y selects */
    .modal .form-select {
        border-radius: 8px;
        border: 2px solid #e9ecef;
        padding: 0.75rem 1rem;
        font-size: 0.95rem;
        background-color: white;
        color: #2c3e50;
        transition: all 0.3s ease;
    }
    
    .modal .form-select:focus {
        border-color: #2c3e50;
        box-shadow: 0 0 0 0.2rem rgba(44, 62, 80, 0.25);
        outline: none;
    }
    
    .modal .form-select option {
        background-color: white;
        color: #2c3e50;
        padding: 8px 12px;
        font-size: 0.95rem;
    }
    
    .modal .form-select option:hover {
        background-color: #f8f9fa;
    }
    
    .modal .form-select option:checked {
        background-color: #2c3e50;
        color: white;
    }
    
    /* Estilos para el select de técnicos específicamente */
    #tecnico_asignado {
        background-color: white !important;
        color: #2c3e50 !important;
    }
    
    #tecnico_asignado option {
        background-color: white !important;
        color: #2c3e50 !important;
        padding: 8px 12px !important;
    }
    
    #tecnico_asignado option:hover {
        background-color: #f8f9fa !important;
    }
    
    #tecnico_asignado option:checked {
        background-color: #2c3e50 !important;
        color: white !important;
    }
    
    /* Estilos para todos los selects del modal */
    .modal select.form-select {
        background-color: white !important;
        color: #2c3e50 !important;
        border: 2px solid #e9ecef !important;
        padding: 0.75rem 1rem !important;
        font-size: 0.95rem !important;
        border-radius: 8px !important;
    }
    
    .modal select.form-select option {
        background-color: white !important;
        color: #2c3e50 !important;
        padding: 8px 12px !important;
        font-size: 0.95rem !important;
        border: none !important;
    }
    
    .modal select.form-select option:hover {
        background-color: #f8f9fa !important;
        color: #2c3e50 !important;
    }
    
    .modal select.form-select option:checked {
        background-color: #2c3e50 !important;
        color: white !important;
    }
    
    /* Estilos específicos para el dropdown del select */
    .modal select.form-select:focus {
        border-color: #2c3e50 !important;
        box-shadow: 0 0 0 0.2rem rgba(44, 62, 80, 0.25) !important;
        outline: none !important;
    }
    
    /* Asegurar que el texto sea visible en todos los navegadores */
    .modal select.form-select,
    .modal select.form-select option {
        -webkit-appearance: none !important;
        -moz-appearance: none !important;
        appearance: none !important;
    }
</style>
{% csrf_token %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-5 mb-3">
                <i class="bi bi-broadcast me-2"></i>Centro de Soluciones Conectadas
            </h1>
            <p class="lead">Panel principal para la gestión de alertas, leads y asignaciones técnicas.</p>
        </div>
    </div>
    
    <!-- KPIs Cards -->
    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="card shadow-sm border-warning">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>Alertas Pendientes
                    </h5>
                    <p class="card-text display-6 text-warning">{{ alertas_pendientes }}</p>
                    <a href="{% url 'centroSoluciones:alertas_list' %}?estado=PENDIENTE" class="btn btn-outline-warning btn-sm">
                        Ver alertas pendientes
                    </a>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm border-info">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-people-fill text-info me-2"></i>Alertas Asignadas
                    </h5>
                    <p class="card-text display-6 text-info">{{ alertas_asignadas }}</p>
                    <a href="{% url 'centroSoluciones:alertas_list' %}?estado=ASIGNADA" class="btn btn-outline-info btn-sm">
                        Ver alertas asignadas
                    </a>
                </div>
            </div>
        </div>
        {% if user.rol == 'GERENTE' or user.rol == 'ADMINISTRATIVO' %}
        <div class="col-md-4">
            <div class="card shadow-sm border-success">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-person-plus-fill text-success me-2"></i>Leads John Deere
                    </h5>
                    <p class="card-text display-6 text-success">{{ leads_nuevos }}</p>
                    <a href="{% url 'centroSoluciones:leads_list' %}" class="btn btn-outline-success btn-sm">
                        Ver leads nuevos
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Acciones Rápidas -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-lightning-fill me-2"></i>Acciones Rápidas
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <a href="{% url 'centroSoluciones:alertas_list' %}" class="btn btn-primary w-100">
                                <i class="bi bi-list-ul me-2"></i>Ver Todas las Alertas
                            </a>
                        </div>
                        {% if user.rol == 'GERENTE' or user.rol == 'ADMINISTRATIVO' %}
                        <div class="col-md-3">
                            <button type="button" class="btn btn-success w-100" data-bs-toggle="modal" data-bs-target="#modalNuevaAlerta">
                                <i class="bi bi-plus-circle me-2"></i>Nueva Alerta
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button type="button" class="btn btn-info w-100" data-bs-toggle="modal" data-bs-target="#modalNuevoLead">
                                <i class="bi bi-person-plus me-2"></i>Nuevo Lead JD
                            </button>
                        </div>
                        {% endif %}
                        {% if user.rol == 'TECNICO' %}
                        <div class="col-md-3">
                            <a href="{% url 'centroSoluciones:alertas_list' %}?estado=ASIGNADA" class="btn btn-warning w-100">
                                <i class="bi bi-tools me-2"></i>Mis Alertas Asignadas
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Información del Usuario -->
    <div class="row">
        <div class="col-12">
            <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                <strong>Bienvenido {{ user.get_nombre_completo }}</strong> - 
                {% if user.rol == 'GERENTE' or user.rol == 'ADMINISTRATIVO' %}
                    Puedes gestionar alertas, leads y asignar técnicos desde este panel.
                {% else %}
                    Puedes ver y procesar las alertas que te han sido asignadas.
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal Nueva Alerta -->
<div class="modal fade" id="modalNuevaAlerta" tabindex="-1" aria-labelledby="modalNuevaAlertaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalNuevaAlertaLabel">
                    <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>Nueva Alerta de Equipo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="formNuevaAlerta">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="cliente_alerta" class="form-label">Cliente *</label>
                            <select class="form-select" id="cliente_alerta" name="cliente" required>
                                <option value="">Seleccionar cliente...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="pin_equipo" class="form-label">PIN del Equipo *</label>
                            <select class="form-select" id="pin_equipo" name="pin_equipo" required>
                                <option value="">Primero selecciona un cliente...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="clasificacion_alerta" class="form-label">Clasificación *</label>
                            <select class="form-select" id="clasificacion_alerta" name="clasificacion" required>
                                <option value="">Seleccionar clasificación...</option>
                                <option value="CRITICA">Crítica</option>
                                <option value="ALTA">Alta</option>
                                <option value="MEDIA">Media</option>
                                <option value="BAJA">Baja</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="codigo_alerta" class="form-label">Código de Alerta *</label>
                            <input type="text" class="form-control" id="codigo_alerta" name="codigo" required>
                        </div>
                        <div class="col-md-6">
                            <label for="tecnico_asignado" class="form-label">Técnico Asignado</label>
                            <select class="form-select" id="tecnico_asignado" name="tecnico_asignado">
                                <option value="">Sin asignar</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label for="descripcion_alerta" class="form-label">Descripción *</label>
                            <textarea class="form-control" id="descripcion_alerta" name="descripcion" rows="3" required></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-circle me-2"></i>Crear Alerta
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Nuevo Lead -->
<div class="modal fade" id="modalNuevoLead" tabindex="-1" aria-labelledby="modalNuevoLeadLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalNuevoLeadLabel">
                    <i class="bi bi-person-plus-fill text-info me-2"></i>Nuevo Lead John Deere
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="formNuevoLead">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="cliente_lead" class="form-label">Cliente *</label>
                            <select class="form-select" id="cliente_lead" name="cliente" required>
                                <option value="">Seleccionar cliente...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="equipo_lead" class="form-label">Equipo *</label>
                            <select class="form-select" id="equipo_lead" name="equipo" required>
                                <option value="">Primero selecciona un cliente...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="clasificacion_lead" class="form-label">Clasificación *</label>
                            <select class="form-select" id="clasificacion_lead" name="clasificacion" required>
                                <option value="">Seleccionar clasificación...</option>
                                <option value="JOHN_DEERE_PROTECT">John Deere Protect</option>
                                <option value="MTTO_PREVENTIVO">Mtto Preventivo</option>
                                <option value="PIP">PIP</option>
                                <option value="REFORMA_COMPONENTES">Reforma de componentes</option>
                                <option value="DIENTES_CUCHILLAS">Dientes / Cuchillas</option>
                                <option value="TREN_RODANTE">Tren rodante</option>
                                <option value="GARANTIA_BASICA">Garantía Básica</option>
                                <option value="GARANTIA_EXTENDIDA">Garantía Extendida</option>
                                <option value="DISPONIBILIDAD">Disponibilidad</option>
                                <option value="RECONEXION">Reconexión</option>
                                <option value="OTROS">Otros</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="valor_estimado" class="form-label">Valor Estimado (USD)</label>
                            <input type="number" class="form-control" id="valor_estimado" name="valor_estimado" step="0.01" min="0">
                        </div>
                        <div class="col-12">
                            <label for="descripcion_lead" class="form-label">Descripción *</label>
                            <textarea class="form-control" id="descripcion_lead" name="descripcion" rows="3" required></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-info">
                        <i class="bi bi-check-circle me-2"></i>Crear Lead
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Toast para notificaciones -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="toastNotificacion" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="bi bi-info-circle me-2"></i>
            <strong class="me-auto">Notificación</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMensaje">
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Cargar clientes al abrir los modales
    const modalNuevaAlerta = document.getElementById('modalNuevaAlerta');
    const modalNuevoLead = document.getElementById('modalNuevoLead');
    
    modalNuevaAlerta.addEventListener('show.bs.modal', function() {
        cargarClientes('cliente_alerta');
        cargarTecnicos();
    });
    
    modalNuevoLead.addEventListener('show.bs.modal', function() {
        cargarClientes('cliente_lead');
    });
    
    // Cargar equipos cuando se selecciona un cliente en el lead
    document.getElementById('cliente_lead').addEventListener('change', function() {
        const clienteId = this.value;
        const equipoSelect = document.getElementById('equipo_lead');
        
        if (clienteId) {
            cargarEquiposCliente(clienteId, equipoSelect);
        } else {
            equipoSelect.innerHTML = '<option value="">Primero selecciona un cliente...</option>';
        }
    });
    
    // Cargar PINs de equipos cuando se selecciona un cliente en la alerta
    document.getElementById('cliente_alerta').addEventListener('change', function() {
        const clienteId = this.value;
        const pinSelect = document.getElementById('pin_equipo');
        
        if (clienteId) {
            cargarPinsEquiposCliente(clienteId, pinSelect);
        } else {
            pinSelect.innerHTML = '<option value="">Primero selecciona un cliente...</option>';
        }
    });
    
    // Manejar envío del formulario de alerta
    document.getElementById('formNuevaAlerta').addEventListener('submit', function(e) {
        e.preventDefault();
        enviarFormularioAlerta();
    });
    
    // Manejar envío del formulario de lead
    document.getElementById('formNuevoLead').addEventListener('submit', function(e) {
        e.preventDefault();
        enviarFormularioLead();
    });
});

// Función para cargar clientes
function cargarClientes(selectId) {
    fetch('{% url "centroSoluciones:obtener_clientes" %}')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">Seleccionar cliente...</option>';
                
                data.clientes.forEach(cliente => {
                    const option = document.createElement('option');
                    option.value = cliente.id;
                    option.textContent = `${cliente.razon_social} (${cliente.cuit})`;
                    select.appendChild(option);
                });
            } else {
                mostrarNotificacion(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error cargando clientes:', error);
            mostrarNotificacion('Error al cargar clientes', 'error');
        });
}

// Función para cargar técnicos
function cargarTecnicos() {
    fetch('{% url "centroSoluciones:obtener_tecnicos" %}')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('tecnico_asignado');
                select.innerHTML = '<option value="">Sin asignar</option>';
                
                data.tecnicos.forEach(tecnico => {
                    const option = document.createElement('option');
                    option.value = tecnico.id;
                    option.textContent = `${tecnico.first_name} ${tecnico.last_name}`;
                    select.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Error cargando técnicos:', error);
        });
}

// Función para cargar equipos de un cliente
function cargarEquiposCliente(clienteId, selectElement) {
    fetch(`{% url "centroSoluciones:obtener_equipos_cliente" %}?cliente_id=${clienteId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                selectElement.innerHTML = '<option value="">Seleccionar equipo...</option>';
                
                data.equipos.forEach(equipo => {
                    const option = document.createElement('option');
                    option.value = equipo.id;
                    option.textContent = `${equipo.numero_serie} - ${equipo.modelo__nombre}`;
                    selectElement.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Error cargando equipos:', error);
            selectElement.innerHTML = '<option value="">Error al cargar equipos...</option>';
        });
}

// Función para cargar PINs de equipos de un cliente
function cargarPinsEquiposCliente(clienteId, selectElement) {
    fetch(`{% url "centroSoluciones:obtener_pins_equipos_cliente" %}?cliente_id=${clienteId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                selectElement.innerHTML = '<option value="">Seleccionar PIN...</option>';
                
                data.pins.forEach(pin => {
                    const option = document.createElement('option');
                    option.value = pin.pin;
                    option.textContent = pin.pin;
                    selectElement.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Error cargando PINs:', error);
            selectElement.innerHTML = '<option value="">Error al cargar PINs...</option>';
        });
}

// Función para enviar formulario de alerta
function enviarFormularioAlerta() {
    const formData = new FormData(document.getElementById('formNuevaAlerta'));
    
    fetch('{% url "centroSoluciones:crear_alerta" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            mostrarNotificacion(data.message, 'success');
            document.getElementById('formNuevaAlerta').reset();
            bootstrap.Modal.getInstance(document.getElementById('modalNuevaAlerta')).hide();
            // Recargar la página para actualizar los contadores
            setTimeout(() => location.reload(), 1500);
        } else {
            mostrarNotificacion(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        mostrarNotificacion('Error al crear la alerta', 'error');
    });
}

// Función para enviar formulario de lead
function enviarFormularioLead() {
    const formData = new FormData(document.getElementById('formNuevoLead'));
    
    fetch('{% url "centroSoluciones:crear_lead" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            mostrarNotificacion(data.message, 'success');
            document.getElementById('formNuevoLead').reset();
            bootstrap.Modal.getInstance(document.getElementById('modalNuevoLead')).hide();
            // Recargar la página para actualizar los contadores
            setTimeout(() => location.reload(), 1500);
        } else {
            mostrarNotificacion(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        mostrarNotificacion('Error al crear el lead', 'error');
    });
}

// Función para mostrar notificaciones
function mostrarNotificacion(mensaje, tipo) {
    const toast = document.getElementById('toastNotificacion');
    const toastBody = document.getElementById('toastMensaje');
    
    toastBody.textContent = mensaje;
    
    // Cambiar color según el tipo
    toast.className = 'toast';
    if (tipo === 'success') {
        toast.classList.add('bg-success', 'text-white');
    } else if (tipo === 'error') {
        toast.classList.add('bg-danger', 'text-white');
    } else {
        toast.classList.add('bg-info', 'text-white');
    }
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
}
</script>
{% endblock %} 