{% extends 'base.html' %}
{% load static %}

{% block title %}Cargar Archivos Mensuales - Centro de Soluciones{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">
                        <i class="fas fa-upload me-2"></i>
                        Cargar Archivos Excel Mensuales
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <form method="post" enctype="multipart/form-data" id="uploadForm">
                                {% csrf_token %}
                                
                                <div class="mb-3">
                                    <label for="tipo" class="form-label">
                                        <strong>Tipo de Archivo *</strong>
                                    </label>
                                    <select class="form-select" id="tipo" name="tipo" required>
                                        <option value="">Seleccione el tipo de archivo...</option>
                                        <option value="UTILIZACION">Datos de Utilización (Analizador_de_máquina)</option>
                                        <option value="NOTIFICACIONES">Notificaciones y Alertas</option>
                                    </select>
                                    <div class="form-text">
                                        Seleccione el tipo de archivo que va a cargar
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="archivo" class="form-label">
                                        <strong>Archivo Excel *</strong>
                                    </label>
                                    <input type="file" class="form-control" id="archivo" name="archivo" 
                                           accept=".xlsx,.xls" required>
                                    <div class="form-text">
                                        Formatos aceptados: .xlsx, .xls (Máximo 50MB)
                                    </div>
                                </div>

                                <div class="alert alert-info">
                                    <h6><i class="fas fa-info-circle me-2"></i>Información sobre los archivos:</h6>
                                    <ul class="mb-0">
                                        <li><strong>Datos de Utilización:</strong> Archivos "Analizador_de_máquina" con información de horas de trabajo, combustible, temperatura, etc.</li>
                                        <li><strong>Notificaciones:</strong> Archivos "Notificaciones" con alertas, códigos de diagnóstico y eventos del equipo.</li>
                                    </ul>
                                </div>

                                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                    <a href="{% url 'centroSoluciones:archivos_mensuales' %}" class="btn btn-secondary me-md-2">
                                        <i class="fas fa-arrow-left me-1"></i>Volver
                                    </a>
                                    <button type="submit" class="btn btn-primary" id="submitBtn">
                                        <i class="fas fa-upload me-1"></i>Cargar Archivo
                                    </button>
                                </div>
                            </form>
                        </div>

                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="fas fa-question-circle me-2"></i>Ayuda
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <h6>Proceso de Carga:</h6>
                                    <ol class="small">
                                        <li>Seleccione el tipo de archivo</li>
                                        <li>Elija el archivo Excel desde su computadora</li>
                                        <li>Haga clic en "Cargar Archivo"</li>
                                        <li>El sistema procesará automáticamente los datos</li>
                                        <li>Podrá ver el progreso en la lista de archivos</li>
                                    </ol>

                                    <h6>Notas Importantes:</h6>
                                    <ul class="small">
                                        <li>Los archivos se procesan en segundo plano</li>
                                        <li>El procesamiento puede tomar varios minutos</li>
                                        <li>Los datos se vinculan automáticamente con equipos existentes</li>
                                        <li>Puede reprocesar archivos si es necesario</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Procesamiento -->
<div class="modal fade" id="processingModal" tabindex="-1" aria-labelledby="processingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="processingModalLabel">
                    <i class="fas fa-cog fa-spin me-2"></i>Procesando Archivo
                </h5>
            </div>
            <div class="modal-body text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Procesando...</span>
                </div>
                <p class="mb-0">El archivo se está cargando y procesando. Esto puede tomar varios minutos.</p>
                <p class="text-muted small">No cierre esta ventana hasta que se complete el proceso.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('uploadForm');
    const submitBtn = document.getElementById('submitBtn');
    const processingModal = new bootstrap.Modal(document.getElementById('processingModal'));

    form.addEventListener('submit', function(e) {
        // Validar archivo
        const fileInput = document.getElementById('archivo');
        const file = fileInput.files[0];
        
        if (file) {
            const maxSize = 50 * 1024 * 1024; // 50MB
            if (file.size > maxSize) {
                e.preventDefault();
                alert('El archivo es demasiado grande. El tamaño máximo es 50MB.');
                return;
            }
            
            const allowedTypes = [
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                'application/vnd.ms-excel'
            ];
            
            if (!allowedTypes.includes(file.type)) {
                e.preventDefault();
                alert('Por favor seleccione un archivo Excel válido (.xlsx o .xls)');
                return;
            }
        }

        // Mostrar modal de procesamiento
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Procesando...';
        processingModal.show();
    });

    // Mostrar nombre del archivo seleccionado
    document.getElementById('archivo').addEventListener('change', function(e) {
        const fileName = e.target.files[0]?.name;
        if (fileName) {
            const fileInfo = document.createElement('div');
            fileInfo.className = 'alert alert-success mt-2';
            fileInfo.innerHTML = `<i class="fas fa-file-excel me-2"></i>Archivo seleccionado: <strong>${fileName}</strong>`;
            
            // Remover información anterior si existe
            const existingInfo = this.parentNode.querySelector('.alert');
            if (existingInfo) {
                existingInfo.remove();
            }
            
            this.parentNode.appendChild(fileInfo);
        }
    });
});
</script>
{% endblock %}
